<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>잔금일 정산내역 ✍️</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap'); /* 제목용 폰트 */
        :root {
            /* CSS 변수 기본값 설정 */
            --accent-color: #2563EB; /* 기본 파란색 */
            --accent-color-light: #BFDBFE;
            --accent-color-start: #3B82F6;
            --accent-color-end: #2563EB;
            --header-bg-image: none; /* 기본 이미지 없음 */
            --header-bg-position: center center;
            --header-bg-size: 40% auto;
            --header-bg-opacity: 0.15;
            --header-mix-blend-mode: soft-light;
        }
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .material-section {
            break-inside: avoid;
            page-break-inside: avoid;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #ffffff; /* 섹션 배경색 */
            border-radius: 0.75rem; /* 둥근 모서리 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* 은은한 그림자 */
        }
        .input-group {
            margin-bottom: 0.5rem;
        }
        .section-divider {
            border-top: 2px solid #e5e7eb;
            margin: 3rem 0; /* 간격 확대 */
        }
        .gradient-header-bg {
            /* 양식명에 따른 테마 색상 그라디언트 (기본: blue) */
            background: linear-gradient(135deg, var(--accent-color-start) 0%, var(--accent-color-end) 100%);
            padding: 2.5rem; /* 패딩 증가 */
            border-radius: 1rem; /* 더 둥근 모서리 */
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); /* 텍스트 그림자 */
            position: relative; /* ::before 가상 요소의 기준점 */
            overflow: hidden; /* 배경 이미지가 박스 밖으로 나가지 않도록 */
            /* 인쇄 시에도 색상 유지를 위해 */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        /* 헤더 배경 이미지 기본 스타일 (가상 요소) */
        .gradient-header-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--header-bg-image); /* JS에서 설정된 이미지 */
            background-repeat: no-repeat;
            background-position: var(--header-bg-position); /* JS에서 설정된 위치 */
            background-size: var(--header-bg-size); /* JS에서 설정된 크기 */
            opacity: var(--header-bg-opacity); /* JS에서 설정된 투명도 */
            z-index: 1; /* 그라디언트 위에 오도록 */
            mix-blend-mode: var(--header-mix-blend-mode); /* JS에서 설정된 블렌딩 모드 */
            /* 인쇄 시에도 색상 유지를 위해 */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .gradient-header-bg h1, .gradient-header-bg p {
            position: relative; /* 텍스트가 이미지 위에 오도록 */
            z-index: 2;
        }
        .accent-border {
            border-left: 5px solid var(--accent-color, #2563EB); /* 테마 색상 경계선 */
            padding-left: 1rem;
        }
        /* H2 및 H3에 동일하게 적용될 섹션 제목 스타일 */
        .section-heading, .document-output h2, .document-output h3 {
            font-family: 'Playfair Display', serif !important; /* Playfair Display 폰트 강제 적용 */
            font-weight: 700 !important; /* 굵게 강제 적용 */
            color: #1F2937 !important; /* 진한 회색 강제 적용 */
            display: flex; /* 아이콘과 텍스트 정렬 */
            align-items: center;
        }
        .section-heading { /* input form의 h3과 output h2에 적용 */
            border-bottom: 3px solid var(--accent-color-light); /* 테마 색상으로 밑줄 */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section-heading i {
            margin-right: 0.75rem;
            color: var(--accent-color);
            -webkit-print-color-adjust: exact; /* 인쇄 시 색상 유지 */
            print-color-adjust: exact;
        }
        /* PDF 생성 기능 관련 CSS */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body {
                -webkit-print-color-adjust: exact; /* Chrome, Safari */
                print-color-adjust: exact; /* 표준 */
                font-size: 11pt; /* 인쇄 시 글꼴 크기 약간 축소 */
                line-height: 1.6;
                color: #333333;
                background-color: transparent !important; /* 배경색 투명하게 */
            }
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            .shadow-lg {
                box-shadow: none !important; /* 전체 그림자 제거 */
            }
            .document-output { /* 보도자료는 Times New Roman 유지 */
                margin: 0;
                padding: 0;
                width: 100%;
                font-family: 'Times New Roman', serif !important; /* 인쇄 시 문서 전체 폰트 */
            }
            /* material-section의 외곽선과 그림자를 인쇄 시에도 유지 */
            .material-section {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important; /* 인쇄 시에도 연한 그림자 유지 */
                border: 1px solid #e5e7eb !important; /* 인쇄 시에도 외곽선 유지 */
                padding: 1.5rem !important; /* 패딩 유지 */
                margin-bottom: 1.5rem !important; /* 마진 유지 */
                background-color: #ffffff !important; /* 배경색 유지 */
                border-radius: 0.5rem !important; /* 둥근 모서리 유지 */
                -webkit-print-color-adjust: exact !important; /* 중요: 배경색 유지 */
                print-color-adjust: exact !important; /* 중요: 배경색 유지 */
            }
            /* h2, h3 제목의 폰트와 굵기 유지 */
            .document-output h2, .document-output h3 {
                font-family: 'Playfair Display', serif !important;
                font-weight: 700 !important;
                color: #1F2937 !important;
            }
            .section-heading { /* 인쇄 시 밑줄 및 마진 재조정 */
                border-bottom: 1px solid #ddd !important; /* 인쇄 시 밑줄 얇게 */
                padding-bottom: 0.25rem !important;
                margin-bottom: 1rem !important;
            }
            /* 그라디언트 헤더 및 색상 요소의 색상 유지 */
            .gradient-header-bg {
                /* 변수 값을 직접 사용하며 !important 강제 */
                background: linear-gradient(135deg, var(--accent-color-start) 0%, var(--accent-color-end) 100%) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color: white !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
                text-shadow: none !important;
                border: none !important;
            }
            .gradient-header-bg::before { /* 인쇄 시 배경 이미지도 유지 */
                background-image: var(--header-bg-image) !important; /* 동적으로 설정된 이미지 유지 */
                background-position: var(--header-bg-position) !important; /* 동적으로 설정된 위치 유지 */
                background-size: var(--header-bg-size) !important; /* 동적으로 설정된 크기 유지 */
                opacity: 0.05 !important; /* 인쇄 시 더 희미하게 */
                mix-blend-mode: normal !important; /* 인쇄 시 블렌딩 모드 제거하여 호환성 개선 */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .accent-border {
                border-left-color: var(--accent-color) !important;
                background-color: #F0F8FF !important; /* 인쇄 시에도 배경색 유지 */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        .print-only { display: none; } /* 기본적으로 숨김 */
        @page {
            size: A4;
            margin: 1in;
        }
        
        /* 모바일 탭 네비게이션 스타일 */
        @media (max-width: 1279px) {
            /* 모바일에서 컨테이너 패딩 최적화 */
            .container {
                padding-top: 1rem !important;
                padding-bottom: 5rem !important; /* 하단 탭바 공간 확보 */
            }
            
            .mobile-section {
                display: none;
            }
            .mobile-section.mobile-active {
                display: block;
            }
            .mobile-tab-active {
                background-color: #3B82F6 !important;
                color: white !important;
            }
            .mobile-tab-inactive {
                background-color: white;
                color: #6B7280;
            }
            .mobile-tab-inactive:hover {
                background-color: #F9FAFB;
            }
            
            /* 모바일에서 메인 콘텐츠를 하나의 컬럼으로 변경 */
            #mainContent {
                display: block !important;
            }
            #mainContent > div {
                width: 100% !important;
                margin-bottom: 1rem;
            }
        }
        
        /* 데스크톱에서는 모든 섹션이 보이도록 */
        @media (min-width: 1280px) {
            .mobile-section {
                display: block !important;
            }
        }
        
        /* 모바일 뷰 테스트 모드 */
        .force-mobile-view #mobileTabNav {
            display: flex !important;
        }
        .force-mobile-view .mobile-section {
            display: none !important;
        }
        .force-mobile-view .mobile-section.mobile-active {
            display: block !important;
        }
        .force-mobile-view #mainContent {
            display: block !important;
        }
        .force-mobile-view #mainContent > div {
            width: 100% !important;
            margin-bottom: 1rem;
        }
        
        /* 스와이프 제스처 애니메이션 */
        @media (max-width: 1279px) {
            .mobile-section {
                transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            }
            .mobile-section.mobile-active {
                transform: translateX(0);
                opacity: 1;
            }
            .swipe-transition {
                transition: transform 0.2s ease-out;
            }
            
            /* 스와이프 힌트 표시 */
            .swipe-hint {
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 100;
                animation: swipeHintFade 3s ease-in-out;
                pointer-events: none;
            }
            
            @keyframes swipeHintFade {
                0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
                20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8 no-print xl:block hidden">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-alt text-blue-600 mr-3"></i> 잔금일 정산내역
            </h1>
            <p class="text-gray-600 text-lg">몇 가지 정보만 입력하면 전문적인 잔금 정산 확인서가 완성됩니다</p>
            
            <!-- Firebase 연결 상태 표시 -->
            <div id="firebaseStatus" class="mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <span>데이터베이스 연결 확인 중...</span>
            </div>
            
            <!-- 개발자용 모바일 테스트 버튼 (데스크톱에서만 표시) -->
            <div class="mt-2 hidden xl:block">
                <button id="mobileTestBtn" onclick="toggleMobileView()" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                    📱 모바일 뷰 테스트
                </button>
            </div>
        </div>
        
        <!-- 모바일 전용 간소화된 헤더 -->
        <div class="xl:hidden mb-4 no-print">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-file-alt text-blue-600 mr-2"></i> 잔금정산서
                </h1>
                <!-- Firebase 연결 상태 (모바일용 아이콘만) -->
                <div id="mobileFirebaseStatus" class="text-xs">
                    <i class="fas fa-spinner fa-spin text-gray-500"></i>
                </div>
            </div>
        </div>
        
        <!-- 모바일 탭 네비게이션 -->
        <div class="xl:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50" id="mobileTabNav">
            <div class="flex">
                <button onclick="showMobileTab('list')" id="tab-list" class="flex-1 py-3 px-4 text-center bg-blue-500 text-white">
                    <i class="fas fa-list block mb-1"></i>
                    <span class="text-xs">목록</span>
                </button>
                <button onclick="showMobileTab('input')" id="tab-input" class="flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-edit block mb-1"></i>
                    <span class="text-xs">입력</span>
                </button>
                <button onclick="showMobileTab('preview')" id="tab-preview" class="flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-file-alt block mb-1"></i>
                    <span class="text-xs">미리보기</span>
                </button>
            </div>
        </div>
        
        
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4" id="mainContent">
            <div id="listSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-6 no-print mobile-section mobile-active">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-blue-500 mr-2"></i>
                    저장된 정산서 목록
                </h2>
                <div id="settlementList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>저장된 정산서가 없습니다.</p>
                        <p class="text-sm">잔금 정산 확인서를 생성하면 자동으로 저장됩니다.</p>
                    </div>
                </div>
            </div>
            
            <div id="inputSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-6 no-print mobile-section">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-edit text-blue-500 mr-2"></i>
                        정보 입력
                    </h2>
                    <div class="flex space-x-1">
                        <button type="submit" form="documentForm" class="bg-green-600 text-white py-2 px-2 rounded-md hover:bg-green-700 transition duration-300 font-medium text-xs">
                            <i class="fas fa-save mr-1"></i>
                            저장
                        </button>
                        <button type="button" id="clearFormButton" class="bg-gray-300 text-gray-800 py-2 px-2 rounded-md hover:bg-gray-400 transition duration-300 font-medium text-xs">
                            <i class="fas fa-trash-alt mr-1"></i>
                            초기화
                        </button>
                    </div>
                </div>
                <form id="documentForm" class="space-y-6">
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-info-circle"></i> 기본 정보
                        </h3>
                        
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="documentTitle">호실명*</label>
                            <input type="text" id="documentTitle" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="settlementDate">잔금일</label>
                            <input type="date" id="settlementDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="managementRequestDate">관리비정산요청일</label>
                            <input type="date" id="managementRequestDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="documentVersion">퇴실점검일정</label>
                            <input type="datetime-local" id="documentVersion" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="releaseDate">입주점검일정</label>
                            <input type="datetime-local" id="releaseDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="depositAccount">보증금반환계좌</label>
                            <textarea id="depositAccount" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                        </div>
                        <div class="input-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="managementFeeAccount">관리비승계계좌</label>
                            <textarea id="managementFeeAccount" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                        </div>
                    </div>

                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-calculator"></i> 정산 금액정보
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="depositReturn">보증금 반환금</label>
                                <input type="text" id="depositReturn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="longTermRepair">장기수선충당금</label>
                                <input type="text" id="longTermRepair" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="managementFee">관리비</label>
                                <input type="text" id="managementFee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="utilityFee">공과금</label>
                                <input type="text" id="utilityFee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="monthlyRent">월세</label>
                                <input type="text" id="monthlyRent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="rentDays">일수 (자동계산)</label>
                                <input type="number" id="rentDays" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="contractEndDate">만기일</label>
                                <input type="date" id="contractEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="moveOutDate">퇴실일</label>
                                <input type="date" id="moveOutDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="flex items-center">
                                <input type="radio" id="overpaid" name="rentType" value="overpaid" class="mr-2">
                                <label for="overpaid" class="text-sm font-medium text-gray-700">과납 (반환 +)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="unpaid" name="rentType" value="unpaid" class="mr-2">
                                <label for="unpaid" class="text-sm font-medium text-gray-700">미납 (반환 -)</label>
                            </div>
                        </div>
                    </div>

                    <div class="pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-check-circle"></i> 잔금일 체크리스트
                        </h3>
                        <div id="checklistContainer" class="space-y-2">
                            <!-- 동적으로 생성되는 체크리스트 항목들 -->
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <input type="text" id="newChecklistItem" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" onclick="addChecklistItem()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-300">
                                <i class="fas fa-plus mr-1"></i>추가
                            </button>
                        </div>
                    </div>

                    <div class="pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-sticky-note"></i> 메모
                        </h3>
                        <textarea id="memoText" class="w-full px-3 py-3 border-2 border-purple-400 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-vertical min-h-[100px]" placeholder="메모를 입력하세요..."></textarea>
                    </div>
                    
                </form>
            </div>
            <div id="previewSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-8 mobile-section">
                <div class="flex items-center justify-between mb-6 no-print">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-alt text-green-600 mr-2"></i>
                        생성된 잔금 정산 확인서
                    </h2>
                    <button onclick="printDocument()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300">
                        <i class="fas fa-print mr-2"></i>
                        PDF 저장
                    </button>
                </div>
                <div id="documentPreview" class="document-output">
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                        <p class="text-lg">좌측 양식을 작성하고 "잔금 정산 확인서 생성하기" 버튼을 클릭하세요</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCb0u5luDHd3rXzK2lfx4wdF_LmpvFLFs4",
            authDomain: "settlement-manager.firebaseapp.com",
            projectId: "settlement-manager",
            storageBucket: "settlement-manager.firebasestorage.app",
            messagingSenderId: "73939961165",
            appId: "1:73939961165:web:9bb4607a9c4c5b73f9e304"
        };

        // Firebase 초기화 (하이브리드 방식 - Firebase 우선, 실패시 localStorage)
        let db = null;
        let settlementsCollection = null;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            settlementsCollection = db.collection('settlements');
            useFirebase = true;
            console.log('✅ Firebase 연결 성공 - 클라우드 데이터베이스 사용');
        } catch (error) {
            console.log('❌ Firebase 연결 실패, localStorage 사용:', error);
            useFirebase = false;
        }

        // 기존 변수들
        const formId = 'documentForm'; // 폼 ID
        const localStorageKeyPrefix = 'form_generator_'; // localStorage 키 접두사
        const settlementListKey = 'settlement_documents_list'; // 정산서 목록 키 (백업용)
        let currentSettlementId = null; // 현재 편집 중인 정산서 ID
        
        // 체크리스트 관리
        let checklistItems = [
            '은행대출금 및 남은 잔금, 월세 입금 확인',
            '퇴실 세입자 관리비 납부 확인',
            '퇴실 세입자 인터넷, 도시가스 등 공과금 납부 확인',
            '관리비 승계 여부 확인',
            '보증금 반환 후 공동현관/호실 비밀번호 확인'
        ];
        
        // 체크리스트 렌더링 함수
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = checklistItems.map((item, index) => `
                <div class="flex items-start group">
                    <input type="checkbox" id="check${index + 1}" class="mt-1 mr-2 accent-color-checkbox" onchange="saveFormDataToLocalStorage(); generateDocument();">
                    <label for="check${index + 1}" class="text-gray-700 flex-1">${index + 1}. ${item}</label>
                    <button type="button" onclick="removeChecklistItem(${index})" class="ml-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // 체크리스트 항목 추가
        function addChecklistItem() {
            const input = document.getElementById('newChecklistItem');
            const newItem = input.value.trim();
            if (newItem) {
                checklistItems.push(newItem);
                input.value = '';
                renderChecklist();
                saveFormDataToLocalStorage();
                generateDocument();
            }
        }
        
        // 체크리스트 항목 삭제
        function removeChecklistItem(index) {
            if (confirm('이 항목을 삭제하시겠습니까?')) {
                checklistItems.splice(index, 1);
                renderChecklist();
                saveFormDataToLocalStorage();
                generateDocument();
            }
        }
        
        // Enter 키로 체크리스트 항목 추가
        function setupChecklistEnterKey() {
            document.getElementById('newChecklistItem').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addChecklistItem();
                }
            });
        }
        
        // 숫자 포맷팅 함수 (쉼표 추가)
        function formatNumberInput(value) {
            // 숫자가 아닌 문자 제거
            const numericValue = value.replace(/[^\d]/g, '');
            // 쉼표 추가
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // 숫자 입력 필드에서 쉼표 제거한 순수 숫자 값 반환
        function getNumericValue(formattedValue) {
            return formattedValue.replace(/,/g, '');
        }
        
        // 금액 입력 필드에 포맷팅 이벤트 설정
        function setupNumberFormatting() {
            const numberInputs = [
                'depositReturn', 'longTermRepair', 'managementFee', 
                'utilityFee', 'monthlyRent'
            ];
            
            numberInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // input 이벤트로 실시간 포맷팅
                    input.addEventListener('input', function(e) {
                        const cursorPosition = e.target.selectionStart;
                        const originalLength = e.target.value.length;
                        
                        const formatted = formatNumberInput(e.target.value);
                        e.target.value = formatted;
                        
                        // 커서 위치 조정 (쉼표 추가로 인한 위치 변경 보정)
                        const newLength = formatted.length;
                        const lengthDiff = newLength - originalLength;
                        const newPosition = cursorPosition + lengthDiff;
                        
                        e.target.setSelectionRange(newPosition, newPosition);
                    });
                    
                    // paste 이벤트 처리
                    input.addEventListener('paste', function(e) {
                        setTimeout(() => {
                            e.target.value = formatNumberInput(e.target.value);
                        }, 0);
                    });
                }
            });
        }
        
        
        // 저장 알림 토스트 함수
        function showSaveNotification(message) {
            // 기존 알림이 있다면 제거
            const existingNotification = document.getElementById('saveNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // 토스트 알림 생성
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md shadow-lg z-50 transform transition-all duration-300 translate-x-full';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 애니메이션으로 표시
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // 하이브리드 정산서 관리 함수들 (Firebase 우선, 실패시 localStorage)
        async function getSettlementList() {
            if (useFirebase) {
                try {
                    const snapshot = await settlementsCollection.orderBy('updatedAt', 'desc').get();
                    const settlements = [];
                    snapshot.forEach(doc => {
                        settlements.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Firebase 데이터를 localStorage에 백업
                    localStorage.setItem(settlementListKey, JSON.stringify(settlements));
                    
                    console.log(`📊 Firebase에서 ${settlements.length}개 정산서 로드됨`);
                    return settlements;
                } catch (error) {
                    console.log('Firebase 읽기 실패, localStorage 사용:', error);
                }
            }
            
            // Firebase 실패하거나 비활성화시 localStorage 사용
            const stored = localStorage.getItem(settlementListKey);
            const list = stored ? JSON.parse(stored) : [];
            console.log(`💾 localStorage에서 ${list.length}개 정산서 로드됨`);
            return list.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }
        
        async function saveSettlement(settlementData) {
            if (useFirebase) {
                try {
                    let savedId;
                    
                    // 기존 문서 업데이트 여부 판단 - currentSettlementId가 있으면 업데이트
                    if (currentSettlementId) {
                        console.log('🔄 기존 정산서 업데이트:', currentSettlementId);
                        
                        // currentSettlementId가 localStorage ID인 경우 Firebase에서 찾기
                        if (currentSettlementId.startsWith('settlement_')) {
                            console.log('🔄 localStorage ID 처리 중, 현재 정산서 정보:', {
                                roomName: settlementData.roomName,
                                settlementDate: settlementData.settlementDate
                            });
                            
                            // localStorage에서 불러온 정산서는 localStorage에서 직접 업데이트
                            settlementData.id = currentSettlementId;
                            saveSettlementToLocalStorage(settlementData);
                            savedId = currentSettlementId;
                            
                            // Firebase에도 동일한 데이터가 있는지 확인하고 있으면 업데이트, 없으면 무시
                            try {
                                const snapshot = await settlementsCollection
                                    .where('roomName', '==', settlementData.roomName)
                                    .where('settlementDate', '==', settlementData.settlementDate)
                                    .get();
                                
                                if (!snapshot.empty) {
                                    // 기존 Firebase 문서가 있으면 업데이트
                                    const firebaseDoc = snapshot.docs[0];
                                    await settlementsCollection.doc(firebaseDoc.id).set({
                                        ...settlementData,
                                        id: firebaseDoc.id // Firebase ID 유지
                                    });
                                    console.log('🔄 Firebase 문서도 업데이트:', firebaseDoc.id);
                                } else {
                                    console.log('🔄 Firebase에 해당 문서 없음, localStorage만 업데이트');
                                }
                            } catch (error) {
                                console.log('Firebase 동기화 실패, localStorage만 업데이트:', error);
                            }
                        } else {
                            // 이미 Firebase ID인 경우 직접 업데이트
                            await settlementsCollection.doc(currentSettlementId).set(settlementData);
                            savedId = currentSettlementId;
                        }
                    } else {
                        // 새 문서 생성
                        console.log('✨ 새 정산서 생성');
                        const docRef = await settlementsCollection.add(settlementData);
                        savedId = docRef.id;
                    }
                    
                    // localStorage ID 업데이트의 경우에는 이미 localStorage 저장이 완료됨
                    if (!currentSettlementId || !currentSettlementId.startsWith('settlement_')) {
                        // Firebase 저장 성공시 localStorage에도 백업 (localStorage ID가 아닌 경우만)
                        settlementData.id = savedId;
                        saveSettlementToLocalStorage(settlementData);
                    }
                    
                    console.log('💾 Firebase와 localStorage에 저장 완료, ID:', savedId);
                    return savedId;
                } catch (error) {
                    console.log('Firebase 저장 실패, localStorage로 대체:', error);
                }
            }
            
            // Firebase 실패시 또는 비활성화시 localStorage 사용
            console.log('💾 localStorage에 저장');
            return saveSettlementToLocalStorage(settlementData);
        }
        
        
        // 백업용 localStorage 함수들
        function getSettlementListFromLocalStorage() {
            const stored = localStorage.getItem(settlementListKey);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveSettlementToLocalStorage(settlementData) {
            let list = getSettlementListFromLocalStorage();
            const existingIndex = list.findIndex(item => item.id === settlementData.id);
            
            if (existingIndex >= 0) {
                list[existingIndex] = settlementData;
            } else {
                if (!settlementData.id) {
                    settlementData.id = generateSettlementId();
                }
                list.push(settlementData);
            }
            
            localStorage.setItem(settlementListKey, JSON.stringify(list));
            return settlementData.id;
        }
        
        function generateSettlementId() {
            return 'settlement_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function saveCurrentSettlement() {
            console.log('💾 저장 시작 - currentSettlementId:', currentSettlementId);
            
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            
            // 체크리스트 항목들도 저장
            formData.checklistItems = checklistItems;
            
            const roomName = document.getElementById('documentTitle').value || '미지정';
            const settlementDate = document.getElementById('settlementDate').value;
            const createdAt = new Date().toISOString();
            
            const settlementData = {
                id: currentSettlementId || generateSettlementId(),
                roomName: roomName,
                settlementDate: settlementDate,
                createdAt: currentSettlementId ? undefined : createdAt, // 기존 문서면 생성일 유지
                updatedAt: createdAt,
                formData: formData
            };
            
            console.log('💾 저장할 데이터:', {
                isUpdate: !!currentSettlementId,
                id: settlementData.id,
                roomName: settlementData.roomName
            });
            
            // 기존 데이터가 있으면 createdAt 유지
            if (currentSettlementId) {
                try {
                    // 먼저 기존 정산서 목록에서 찾기
                    const existingList = await getSettlementList();
                    const existing = existingList.find(item => item.id === currentSettlementId);
                    if (existing && existing.createdAt) {
                        settlementData.createdAt = existing.createdAt;
                    } else {
                        settlementData.createdAt = createdAt;
                    }
                } catch (error) {
                    console.error('기존 데이터 조회 실패:', error);
                    settlementData.createdAt = createdAt;
                }
            } else {
                settlementData.createdAt = createdAt;
            }
            
            const savedId = await saveSettlement(settlementData);
            currentSettlementId = savedId;
            updateSettlementListUI();
            
            return savedId;
        }
        
        async function loadSettlement(id) {
            try {
                console.log('📁 정산서 불러오기 시작 - ID:', id);
                
                // 하이브리드 방식으로 정산서 목록에서 찾기
                const list = await getSettlementList();
                const settlement = list.find(item => item.id === id);
                
                if (settlement) {
                    currentSettlementId = id;
                    console.log('📁 currentSettlementId 설정:', currentSettlementId);
                    const formData = settlement.formData;
                    
                    // 체크리스트 항목들 로드
                    if (formData.checklistItems) {
                        checklistItems = formData.checklistItems;
                        renderChecklist();
                    }
                    
                    // 폼에 데이터 로드
                    for (const elementId in formData) {
                        if (elementId === 'checklistItems') continue; // 체크리스트는 별도 처리됨
                        const element = document.getElementById(elementId);
                        if (element) {
                            if (element.type === 'checkbox' || element.type === 'radio') {
                                element.checked = formData[elementId];
                            } else {
                                element.value = formData[elementId];
                            }
                        }
                    }
                    
                    generateDocument();
                    updateSettlementListUI(); // UI 업데이트
                    
                    // 모바일에서 정산서 로드 시 입력 탭으로 자동 전환
                    if (window.innerWidth < 1280) {
                        showMobileTab('input');
                    }
                    
                    console.log('📄 정산서 로드 완료:', settlement.roomName || '미지정');
                } else {
                    console.error('정산서를 찾을 수 없습니다:', id);
                    alert('정산서를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('정산서 로드 중 오류:', error);
                alert('정산서 로드 중 오류가 발생했습니다.');
            }
        }
        
        async function deleteSettlement(id) {
            console.log('🗑️ 삭제 요청 - ID:', id);
            
            if (confirm('정말로 이 정산서를 삭제하시겠습니까?')) {
                try {
                    console.log('🗑️ 삭제 확인됨, 삭제 시작');
                    
                    // Firebase에서 삭제 시도
                    if (useFirebase) {
                        try {
                            if (id.startsWith('settlement_')) {
                                console.log('🗑️ localStorage ID이므로 Firebase에서 매칭되는 문서 찾아서 삭제');
                                // localStorage ID인 경우, 같은 데이터를 가진 Firebase 문서 찾기
                                const list = await getSettlementList();
                                const settlement = list.find(item => item.id === id);
                                if (settlement) {
                                    // Firebase에서 같은 roomName과 settlementDate를 가진 문서들 찾기
                                    const snapshot = await settlementsCollection
                                        .where('roomName', '==', settlement.roomName)
                                        .where('settlementDate', '==', settlement.settlementDate)
                                        .get();
                                    
                                    // Firebase 문서들 삭제
                                    const deletePromises = [];
                                    snapshot.forEach(doc => {
                                        console.log('🗑️ Firebase 문서 삭제:', doc.id);
                                        deletePromises.push(settlementsCollection.doc(doc.id).delete());
                                    });
                                    
                                    await Promise.all(deletePromises);
                                    console.log('🗑️ Firebase에서 관련 문서 삭제 완료');
                                }
                            } else {
                                console.log('🗑️ Firebase ID로 직접 삭제:', id);
                                await settlementsCollection.doc(id).delete();
                                console.log('🗑️ Firebase에서 삭제 완료');
                            }
                        } catch (error) {
                            console.log('Firebase 삭제 실패:', error);
                        }
                    }
                    
                    // localStorage에서도 삭제
                    console.log('🗑️ localStorage에서 삭제 시도');
                    let list = getSettlementListFromLocalStorage();
                    console.log('🗑️ 삭제 전 목록 개수:', list.length);
                    list = list.filter(item => item.id !== id);
                    console.log('🗑️ 삭제 후 목록 개수:', list.length);
                    localStorage.setItem(settlementListKey, JSON.stringify(list));
                    
                    if (currentSettlementId === id) {
                        console.log('🗑️ 현재 편집 중인 정산서 삭제됨, 폼 초기화');
                        currentSettlementId = null;
                        clearForm(); // 현재 편집 중이던 정산서를 삭제했다면 폼도 초기화
                    }
                    
                    console.log('🗑️ UI 업데이트 시작');
                    await updateSettlementListUI();
                    console.log('🗑️ 정산서 삭제 완료');
                    
                    // 삭제 성공 메시지
                    alert('정산서가 삭제되었습니다.');
                } catch (error) {
                    console.error('정산서 삭제 중 오류:', error);
                    alert('정산서 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            } else {
                console.log('🗑️ 삭제 취소됨');
            }
        }
        
        async function updateSettlementListUI() {
            console.log('🔄 목록 UI 업데이트 시작');
            const list = await getSettlementList();
            console.log('🔄 불러온 목록 개수:', list.length);
            const listDiv = document.getElementById('settlementList');
            
            if (list.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>저장된 정산서가 없습니다.</p>
                        <p class="text-sm">잔금 정산 확인서를 생성하면 자동으로 저장됩니다.</p>
                    </div>
                `;
                return;
            }
            
            // 잔금일순 정렬 (빠른순)
            list.sort((a, b) => {
                const dateA = a.settlementDate ? new Date(a.settlementDate) : new Date('9999-12-31'); // 잔금일이 없으면 맨 뒤로
                const dateB = b.settlementDate ? new Date(b.settlementDate) : new Date('9999-12-31');
                return dateA - dateB; // 오름차순 (빠른 날짜가 먼저)
            });
            
            listDiv.innerHTML = list.map(settlement => {
                const isCurrentlyEditing = currentSettlementId === settlement.id;
                const updatedDate = new Date(settlement.updatedAt).toLocaleDateString('ko-KR');
                const settlementDisplayDate = settlement.settlementDate ? 
                    new Date(settlement.settlementDate).toLocaleDateString('ko-KR') : '미정';
                
                // 상세 정보 추출
                const formData = settlement.formData || {};
                const depositReturn = parseInt(formData.depositReturn || 0);
                const longTermRepair = parseInt(formData.longTermRepair || 0);
                const monthlyRent = parseInt(formData.monthlyRent || 0);
                const rentDays = parseInt(formData.rentDays || 0);
                const managementFee = parseInt(formData.managementFee || 0);
                const utilityFee = parseInt(formData.utilityFee || 0);
                
                // 월세 일할계산
                const dailyRentCalculation = Math.round((monthlyRent * rentDays * 12) / 365);
                const isOverpaid = formData.overpaid;
                const isUnpaid = formData.unpaid;
                
                // 반환금합계 (월세 제외)
                let totalRefund = depositReturn + longTermRepair;
                
                // 월세포함반환금 계산
                let totalRefundWithRent = totalRefund;
                if (isOverpaid) totalRefundWithRent += dailyRentCalculation;
                else if (isUnpaid) totalRefundWithRent -= dailyRentCalculation;
                
                // 숫자 포맷팅 함수
                const formatKRW = (num) => `${num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                
                return `
                    <div class="border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors ${isCurrentlyEditing ? 'bg-blue-50 border-blue-300' : ''} mb-3">
                        <div class="p-3">
                            <div class="flex flex-col">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold text-gray-800 flex items-center text-sm">
                                        ${isCurrentlyEditing ? '<i class="fas fa-edit text-blue-500 mr-2"></i>' : '<i class="fas fa-file-alt text-gray-500 mr-2"></i>'}
                                        ${settlement.roomName}
                                    </h3>
                                    ${isCurrentlyEditing ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">편집중</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-600 mb-2">
                                    <div>잔금일: ${settlementDisplayDate}</div>
                                    <div>반환금: ${formatKRW(totalRefund)}</div>
                                </div>
                                <div class="flex space-x-1" onclick="event.stopPropagation()">
                                    ${!isCurrentlyEditing ? `
                                        <button onclick="loadSettlement('${settlement.id}')" class="flex-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                            <i class="fas fa-edit mr-1"></i>불러오기
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteSettlement('${settlement.id}')" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors">
                                        <i class="fas fa-trash mr-1"></i>삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        
        function printDocument() {
            const roomName = document.getElementById('documentTitle').value || '정산서';
            const settlementDate = document.getElementById('settlementDate').value;
            
            // 파일명 생성 (띄어쓰기 제거 및 특수문자 처리)
            let fileName = roomName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9가-힣_-]/g, '');
            if (settlementDate) {
                const dateStr = settlementDate.replace(/-/g, '');
                fileName += '_' + dateStr;
            }
            fileName += '_잔금정산서';
            
            // 브라우저 제목을 파일명으로 임시 변경
            const originalTitle = document.title;
            document.title = fileName;
            
            // 인쇄 실행
            window.print();
            
            // 제목 복원 (인쇄 후)
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }
        
        // 모든 입력 필드에서 데이터를 수집하여 localStorage에 저장
        function saveFormDataToLocalStorage() {
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) { // ID가 있는 요소만 저장
                    if (element.type === 'checkbox') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            
            // 체크리스트 항목들도 저장
            formData.checklistItems = checklistItems;
            localStorage.setItem(localStorageKeyPrefix + formId, JSON.stringify(formData));
            // console.log('Form data saved to localStorage');
        }
        // localStorage에서 데이터를 불러와 입력 필드에 채움
        function loadFormDataFromLocalStorage() {
            const savedData = localStorage.getItem(localStorageKeyPrefix + formId);
            if (savedData) {
                const formData = JSON.parse(savedData);
                
                // 체크리스트 항목들 로드
                if (formData.checklistItems) {
                    checklistItems = formData.checklistItems;
                    renderChecklist();
                }
                
                for (const id in formData) {
                    if (id === 'checklistItems') continue; // 체크리스트는 별도 처리
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = formData[id];
                        } else {
                            element.value = formData[id];
                        }
                    }
                }
                // console.log('Form data loaded from localStorage');
                // 데이터 로드 후 바로 미리보기 생성
                generateDocument();
            } else {
                generateDocument();
            }
        }
        // 입력 필드 초기화 (로컬스토리지 포함)
        function clearForm() {
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.type === 'checkbox') {
                    element.checked = false;
                } else if (element.tagName === 'SELECT') {
                    element.value = ''; // select 박스는 첫 번째 옵션 또는 빈 값으로
                } else {
                    element.value = ''; // 텍스트, textarea 등은 빈 문자열로
                }
            });
            localStorage.removeItem(localStorageKeyPrefix + formId); // localStorage에서도 삭제
            generateDocument(); // 초기화 후 미리보기 업데이트
            // console.log('Form data cleared');
        }
        // 현재 양식 데이터를 JSON 파일로 다운로드
        function downloadDataFile() {
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            const dataStr = JSON.stringify(formData, null, 2); // 보기 좋게 포맷팅
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // 파일명에 현재 양식명과 날짜 포함
            const formTitle = document.getElementById('documentTitle').value.replace(/[^a-zA-Z0-9가-힣_]/g, '_') || '새_양식';
            a.download = `${formTitle}_데이터_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // URL 객체 해제
        }
        // JSON 파일을 읽어 양식에 불러오기
        function uploadDataFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    for (const id in loadedData) {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = loadedData[id];
                            } else {
                                element.value = loadedData[id];
                            }
                        }
                    }
                    saveFormDataToLocalStorage(); // 불러온 데이터도 로컬 저장소에 저장
                    generateDocument(); // 불러온 데이터로 미리보기 업데이트
                    alert('데이터를 성공적으로 불러왔습니다!');
                } catch (error) {
                    alert('파일을 읽는 중 오류가 발생했거나 유효한 JSON 파일이 아닙니다: ' + error.message);
                }
            };
            reader.readAsText(file);
            // 파일 선택 후 input 값 초기화 (동일 파일 재선택 가능하도록)
            event.target.value = '';
        }
        
        // 날짜 차이 계산 함수
        function calculateDateDifference() {
            const contractEndDate = document.getElementById('contractEndDate').value;
            const moveOutDate = document.getElementById('moveOutDate').value;
            
            if (contractEndDate && moveOutDate) {
                const endDate = new Date(contractEndDate);
                const outDate = new Date(moveOutDate);
                const timeDiff = Math.abs(outDate - endDate);
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                document.getElementById('rentDays').value = daysDiff;
                generateDocument(); // 일수가 변경되면 문서도 자동 업데이트
            }
        }
        
        // 문서 생성 함수
        function generateDocument() {
            // 입력값 수집
            const settlementDateInput = document.getElementById('settlementDate');
            const documentTitleInput = document.getElementById('documentTitle');
            const documentVersionInput = document.getElementById('documentVersion');
            const releaseDateInput = document.getElementById('releaseDate');
            const depositReturnInput = document.getElementById('depositReturn');
            const longTermRepairInput = document.getElementById('longTermRepair');
            const monthlyRentInput = document.getElementById('monthlyRent');
            const rentDaysInput = document.getElementById('rentDays');
            const contractEndDateInput = document.getElementById('contractEndDate');
            const moveOutDateInput = document.getElementById('moveOutDate');
            const managementFeeInput = document.getElementById('managementFee');
            const utilityFeeInput = document.getElementById('utilityFee');
            const managementRequestDateInput = document.getElementById('managementRequestDate');
            const depositAccountInput = document.getElementById('depositAccount');
            const managementFeeAccountInput = document.getElementById('managementFeeAccount');
            const memoTextInput = document.getElementById('memoText');
            // 체크리스트 상태 수집
            const checks = {};
            checklistItems.forEach((item, index) => {
                const checkbox = document.getElementById(`check${index + 1}`);
                checks[`check${index + 1}`] = checkbox ? checkbox.checked : false;
            });
            
            // 과납/미납 체크 상태 확인
            const isOverpaid = document.getElementById('overpaid').checked;
            const isUnpaid = document.getElementById('unpaid').checked;
            
            const settlementDate = settlementDateInput.value;
            const documentTitle = documentTitleInput.value || documentTitleInput.placeholder || '잔금 정산 확인서';
            const documentVersion = documentVersionInput.value || documentVersionInput.placeholder || '';
            const releaseDate = releaseDateInput.value;
            const managementRequestDate = managementRequestDateInput.value;
            // 쉼표 제거하고 숫자값 추출
            const depositReturn = getNumericValue(depositReturnInput.value) || '0';
            const longTermRepair = getNumericValue(longTermRepairInput.value) || '0';
            const monthlyRent = getNumericValue(monthlyRentInput.value) || '0';
            const rentDays = rentDaysInput.value || '0';
            const managementFee = getNumericValue(managementFeeInput.value) || '0';
            const utilityFee = getNumericValue(utilityFeeInput.value) || '0';
            
            // 월세 일할계산 공식: 월세 * 일수 * 12 / 365
            const dailyRentCalculation = Math.round((parseFloat(monthlyRent) * parseFloat(rentDays) * 12) / 365);
            
            // 반환금합계 계산 (보증금 + 장기수선충당금, 월세 제외)
            let totalRefund = parseFloat(depositReturn) + parseFloat(longTermRepair);
            
            // 월세포함반환금 계산
            let totalRefundWithRent = totalRefund;
            if (isOverpaid) totalRefundWithRent += dailyRentCalculation;
            else if (isUnpaid) totalRefundWithRent -= dailyRentCalculation;
            const depositAccount = depositAccountInput.value || depositAccountInput.placeholder || '계좌 정보 미입력';
            const managementFeeAccount = managementFeeAccountInput.value || managementFeeAccountInput.placeholder || '계좌 정보 미입력';
            const memoText = memoTextInput.value || '';

            // 체크박스 HTML 생성 함수
            function getChecklistItem(label, isChecked) {
                const icon = isChecked ? '<i class="fas fa-check-square text-green-600 mr-2"></i>' : '<i class="fas fa-square text-gray-400 mr-2"></i>';
                const textStyle = isChecked ? 'text-decoration-line: line-through; color: #9CA3AF;' : '';
                return `<li class="flex items-start mb-1">${icon}<span style="${textStyle}">${label}</span></li>`;
            }

            // 숫자 포맷팅 함수 (원 단위, 세 자리마다 쉼표 + 한글 표기)
            function formatNumber(num) {
                const numValue = parseInt(num) || 0;
                let result = `${numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
                
                // 1000만원 이상일 경우 한글 표기 추가
                if (numValue >= 100000000) { // 1억 이상
                    const eok = Math.floor(numValue / 100000000);
                    const remain = numValue % 100000000;
                    const cheon = Math.floor(remain / 10000000);
                    const manwon = Math.floor((remain % 10000000) / 10000);
                    
                    let hangeul = `${eok}억`;
                    if (cheon > 0) hangeul += `${cheon}천`;
                    if (manwon > 0) hangeul += `${manwon}만`;
                    hangeul += '원';
                    
                    result += ` (${hangeul})`;
                } else if (numValue >= 10000000) { // 1천만원 이상 1억 미만
                    const cheon = Math.floor(numValue / 10000000);
                    const manwon = Math.floor((numValue % 10000000) / 10000);
                    
                    let hangeul = '';
                    if (cheon > 0) hangeul += `${cheon}천`;
                    if (manwon > 0) hangeul += `${manwon}만`;
                    hangeul += '원';
                    
                    result += ` (${hangeul})`;
                }
                
                return result;
            }

            // CSS 변수 동적 설정 (테마 색상 및 배경 이미지)
            const root = document.documentElement;
            let themeColor = '#F97316'; // Orange
            let themeColorLight = '#FED7AA';
            let themeColorStart = '#F97316';
            let themeColorEnd = '#EA580C';
            let headerBgImage = "none";
            let headerBgPosition = 'right 15% top 15%';
            let headerBgSize = '30% auto';
            let headerBgOpacity = 0.15;
            let headerMixBlendMode = 'soft-light';

            root.style.setProperty('--accent-color', themeColor);
            root.style.setProperty('--accent-color-light', themeColorLight);
            root.style.setProperty('--accent-color-start', themeColorStart);
            root.style.setProperty('--accent-color-end', themeColorEnd);
            root.style.setProperty('--header-bg-image', headerBgImage);
            root.style.setProperty('--header-bg-position', headerBgPosition);
            root.style.setProperty('--header-bg-size', headerBgSize);
            root.style.setProperty('--header-bg-opacity', headerBgOpacity);
            root.style.setProperty('--header-mix-blend-mode', headerMixBlendMode);

            // 간단한 포맷팅 함수
            const formatKRW = (num) => {
                const numValue = parseInt(num) || 0;
                return `${numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}원`;
            };

            // 날짜 포맷팅 함수 (2025년 8월 30일 형태)
            const formatDate = (dateString) => {
                if (!dateString) return '미정';
                const date = new Date(dateString);
                return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            };

            // 날짜시간 포맷팅 함수 (2025년 8월 30일 10시 59분 형태)
            const formatDateTime = (dateTimeString) => {
                if (!dateTimeString) return '미정';
                const date = new Date(dateTimeString);
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일 ${hours}시 ${minutes}분`;
            };

            let generatedHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px;">
                    <!-- 기본 정보 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <div style="margin-bottom: 12px;">
                            <div>
                                <h3 style="font-weight: 600; color: #374151; font-size: 16px; margin: 0 0 8px 0; display: flex; align-items: center;">
                                    📄 ${documentTitle || '미지정'} 잔금 정산 확인서
                                </h3>
                                <div style="font-size: 12px; margin-top: 4px;">
                                    <div style="margin-bottom: 2px; color: #dc2626;"><strong>퇴실점검:</strong> ${documentVersion ? formatDateTime(documentVersion) : '미정'}</div>
                                    <div style="margin-bottom: 2px; color: #dc2626;"><strong>입주점검:</strong> ${releaseDate ? formatDateTime(releaseDate) : '미정'}</div>
                                    ${managementRequestDate ? `<div style="margin-bottom: 2px; color: #2563eb;"><strong>관리비정산요청일:</strong> ${formatDate(managementRequestDate)}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${settlementDate ? `<div style="margin-bottom: 4px;"><strong>잔금일:</strong> ${formatDate(settlementDate)}</div>` : ''}
                        </div>
                    </div>

                    <!-- 정산 내역 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            💰 정산 내역
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${depositReturn && parseInt(depositReturn) > 0 ? `<span>보증금: ${formatKRW(depositReturn)}</span>` : ''}${longTermRepair && parseInt(longTermRepair) > 0 ? `${depositReturn && parseInt(depositReturn) > 0 ? '<br>' : ''}<span>장기수선: ${formatKRW(longTermRepair)}</span>` : ''}${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `${(depositReturn && parseInt(depositReturn) > 0) || (longTermRepair && parseInt(longTermRepair) > 0) ? '<br>' : ''}<span>월세 ${isOverpaid ? '(과납)' : '(미납)'}: ${isUnpaid ? '- ' : ''}${formatKRW(dailyRentCalculation)}</span>` : ''}
                            <div style="font-weight: 600; border-top: 1px solid #d1d5db; padding-top: 4px; margin-top: 8px;">
                                반환금합계: ${formatKRW(totalRefund)}
                            </div>
                            ${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `
                                <div style="font-weight: 600; margin-top: 4px; color: #059669;">
                                    월세포함반환금: ${formatKRW(totalRefundWithRent)}
                                </div>
                            ` : ''}
                            ${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; ${isUnpaid ? 'color: #dc2626;' : 'color: #2563eb;'} font-weight: 500;">
                                        ${isUnpaid ? 
                                            `미납월세 ${formatKRW(dailyRentCalculation)}을 임대인에게 납부하셔야 합니다.` :
                                            `더 납부된 월세 ${formatKRW(dailyRentCalculation)}을 세입자에게 반환하셔야 합니다.`
                                        }
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${(managementFee && parseInt(managementFee) > 0) || (utilityFee && parseInt(utilityFee) > 0) ? `
                    <!-- 관리비/공과금 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            🧾 관리비/공과금
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${managementFee && parseInt(managementFee) > 0 ? `<span>관리비: ${formatKRW(managementFee)}</span>` : ''}${utilityFee && parseInt(utilityFee) > 0 ? `${managementFee && parseInt(managementFee) > 0 ? '<br>' : ''}<span>공과금: ${formatKRW(utilityFee)}</span>` : ''}
                            ${managementFee && parseInt(managementFee) > 0 ? `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; line-height: 1.4;">
                                    본 오피스텔은 전출입 세입자간에 관리비를 승계하는 것을 원칙으로 하고 있습니다. 전입세입자분의 계좌번호가 확인되는데로 보내드리겠습니다. 해당 계좌로 관리비를 입금해 주시면 됩니다.<br>
                                    <strong style="color: #374151;">관리비승계 계좌번호:</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${(depositAccount || managementFeeAccount) ? `
                    <!-- 계좌 정보 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            🏦 계좌 정보
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${depositAccount ? `
                                <div style="margin-bottom: 8px;">
                                    <strong style="display: block; margin-bottom: 4px;">보증금/장기수선충당금 반환 계좌:</strong>
                                    <div style="white-space: pre-wrap; padding-left: 8px; color: #6b7280;">${depositAccount}</div>
                                </div>
                            ` : ''}
                            ${managementFeeAccount ? `
                                <div style="margin-bottom: 8px;">
                                    <strong style="display: block; margin-bottom: 4px;">관리비 승계 계좌:</strong>
                                    <div style="white-space: pre-wrap; padding-left: 8px; color: #6b7280;">${managementFeeAccount}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${checklistItems.length > 0 ? `
                    <!-- 체크리스트 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            ✅ 잔금일 체크리스트
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${checklistItems.map((item, index) => {
                                const isChecked = checks[`check${index + 1}`];
                                const icon = isChecked ? '✅' : '⬜';
                                const textStyle = isChecked ? 'text-decoration: line-through; color: #9ca3af;' : '';
                                return `<div style="display: flex; align-items: flex-start; margin-bottom: 4px;"><span style="margin-right: 8px;">${icon}</span><span style="${textStyle}">${item}</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${memoText ? `
                    <!-- 메모 카드 -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 8px 0; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">📝</span>
                            <span>메모</span>
                        </h4>
                        <div style="font-size: 12px; color: #4b5563; white-space: pre-wrap; line-height: 1.6; text-align: left; vertical-align: top; word-wrap: break-word; margin-left: 0; padding-left: 0;">${memoText}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('documentPreview').innerHTML = generatedHtml;
            // 모바일에서 저장 버튼 클릭 시 미리보기 탭으로 자동 전환
            if (window.innerWidth < 1280) {
                const currentActiveTab = document.querySelector('.mobile-tab-active');
                if (currentActiveTab && currentActiveTab.id === 'tab-input') {
                    // 입력 탭에서 저장했다면 미리보기 탭으로 전환
                    showMobileTab('preview');
                }
            }
        }
        // placeholder 텍스트를 실제 값으로 채우는 함수
        function setupInputPlaceholders() {
            const inputs = document.querySelectorAll('#documentForm input[placeholder], #documentForm textarea[placeholder]');
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab' && input.value.trim() === '') {
                        e.preventDefault(); // 기본 Tab 동작 방지
                        input.value = input.placeholder;
                        saveFormDataToLocalStorage(); // Tab 키로 입력 시 자동 저장
                        generateDocument(); // Tab 키로 입력 시 미리보기 업데이트
                    }
                });
            });
        }
        // Firebase 연결 테스트 함수
        async function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebaseStatus');
            const mobileStatusDiv = document.getElementById('mobileFirebaseStatus');
            
            if (useFirebase) {
                try {
                    console.log('🔍 Firebase 연결 테스트 중...');
                    const testData = {
                        test: true,
                        timestamp: new Date().toISOString(),
                        roomName: 'Firebase 연결 테스트',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const docRef = await settlementsCollection.add(testData);
                    await settlementsCollection.doc(docRef.id).delete(); // 테스트 데이터 즉시 삭제
                    console.log('✅ Firebase 연결 및 읽기/쓰기 테스트 성공!');
                    console.log('🌐 클라우드 데이터베이스가 정상적으로 작동합니다.');
                    
                    // 데스크톱 UI 상태 업데이트
                    if (statusDiv) {
                        statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-green-100 text-green-800';
                        statusDiv.innerHTML = '<i class="fas fa-cloud mr-2"></i><span>클라우드 데이터베이스 연결됨 - 어디서나 접근 가능</span>';
                    }
                    
                    // 모바일 UI 상태 업데이트
                    if (mobileStatusDiv) {
                        mobileStatusDiv.innerHTML = '<i class="fas fa-cloud text-green-600"></i>';
                        mobileStatusDiv.title = '클라우드 DB 연결됨';
                    }
                    
                    return true;
                } catch (error) {
                    console.log('❌ Firebase 연결 테스트 실패:', error);
                    console.log('💾 localStorage만 사용됩니다.');
                    
                    // 데스크톱 UI 상태 업데이트
                    if (statusDiv) {
                        statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-yellow-100 text-yellow-800';
                        statusDiv.innerHTML = '<i class="fas fa-database mr-2"></i><span>로컬 저장소 사용 중 - 이 브라우저에서만 접근</span>';
                    }
                    
                    // 모바일 UI 상태 업데이트
                    if (mobileStatusDiv) {
                        mobileStatusDiv.innerHTML = '<i class="fas fa-database text-yellow-600"></i>';
                        mobileStatusDiv.title = '로컬 저장소만 사용';
                    }
                    
                    return false;
                }
            } else {
                console.log('💾 Firebase가 비활성화되어 localStorage만 사용됩니다.');
                
                // 데스크톱 UI 상태 업데이트
                if (statusDiv) {
                    statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-gray-100 text-gray-800';
                    statusDiv.innerHTML = '<i class="fas fa-database mr-2"></i><span>로컬 저장소만 사용</span>';
                }
                
                // 모바일 UI 상태 업데이트
                if (mobileStatusDiv) {
                    mobileStatusDiv.innerHTML = '<i class="fas fa-database text-gray-600"></i>';
                    mobileStatusDiv.title = '로컬 저장소만 사용';
                }
                
                return false;
            }
        }

        // 스와이프 제스처 관리 변수들
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const minSwipeDistance = 50; // 최소 스와이프 거리
        const maxVerticalDistance = 100; // 세로 방향 최대 허용 거리

        // 스와이프 제스처 감지 함수들
        function handleTouchStart(e) {
            // 모바일 환경이 아니고 강제 모바일 뷰도 아니면 실행하지 않음
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            const firstTouch = e.touches[0];
            touchStartX = firstTouch.clientX;
            touchStartY = firstTouch.clientY;
        }

        function handleTouchMove(e) {
            // 모바일 환경이 아니고 강제 모바일 뷰도 아니면 실행하지 않음
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            if (!touchStartX || !touchStartY) return;

            const currentTouch = e.touches[0];
            touchEndX = currentTouch.clientX;
            touchEndY = currentTouch.clientY;

            // 세로 스와이프가 너무 크면 가로 스와이프로 인식하지 않음
            const verticalDistance = Math.abs(touchEndY - touchStartY);
            const horizontalDistance = Math.abs(touchEndX - touchStartX);
            
            // 가로 스와이프가 세로 스와이프보다 크고, 세로 거리가 허용 범위 내일 때만 스크롤 방지
            if (horizontalDistance > verticalDistance && verticalDistance < maxVerticalDistance) {
                e.preventDefault(); // 스와이프 중 페이지 스크롤 방지
            }
        }

        function handleTouchEnd(e) {
            // 모바일 환경이 아니고 강제 모바일 뷰도 아니면 실행하지 않음
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            if (!touchStartX || !touchStartY) return;

            const horizontalDistance = touchEndX - touchStartX;
            const verticalDistance = Math.abs(touchEndY - touchStartY);

            // 세로 방향 이동이 너무 크면 스와이프로 인식하지 않음
            if (verticalDistance > maxVerticalDistance) {
                resetTouchVariables();
                return;
            }

            // 최소 스와이프 거리 체크
            if (Math.abs(horizontalDistance) < minSwipeDistance) {
                resetTouchVariables();
                return;
            }

            // 현재 활성 탭 확인
            const currentActiveTab = document.querySelector('.mobile-tab-active');
            if (!currentActiveTab) {
                resetTouchVariables();
                return;
            }

            const currentTabId = currentActiveTab.id;
            let nextTab = null;

            if (horizontalDistance > 0) {
                // 오른쪽 스와이프 (이전 탭으로)
                console.log('👆 오른쪽 스와이프 감지 - 이전 탭으로');
                if (currentTabId === 'tab-input') {
                    nextTab = 'list';
                } else if (currentTabId === 'tab-preview') {
                    nextTab = 'input';
                }
            } else {
                // 왼쪽 스와이프 (다음 탭으로)
                console.log('👆 왼쪽 스와이프 감지 - 다음 탭으로');
                if (currentTabId === 'tab-list') {
                    nextTab = 'input';
                } else if (currentTabId === 'tab-input') {
                    nextTab = 'preview';
                }
            }

            if (nextTab) {
                console.log('👆 탭 전환:', currentTabId, '→', nextTab);
                showMobileTab(nextTab);
                
                // 햅틱 피드백 (지원되는 기기에서)
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            resetTouchVariables();
        }

        function resetTouchVariables() {
            touchStartX = 0;
            touchStartY = 0;
            touchEndX = 0;
            touchEndY = 0;
        }

        // 모바일 탭 전환 기능
        function showMobileTab(tabName) {
            // 모바일 환경이 아니고 강제 모바일 뷰도 아니면 실행하지 않음
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            // 모든 섹션 숨기기
            const sections = document.querySelectorAll('.mobile-section');
            sections.forEach(section => {
                section.classList.remove('mobile-active');
            });
            
            // 모든 탭 버튼 비활성화 스타일 적용
            const tabs = document.querySelectorAll('#mobileTabNav button');
            tabs.forEach(tab => {
                tab.className = 'flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 mobile-tab-inactive';
            });
            
            // 선택된 탭과 섹션 활성화
            const targetSection = document.getElementById(tabName + 'Section');
            const targetTab = document.getElementById('tab-' + tabName);
            
            if (targetSection) {
                targetSection.classList.add('mobile-active');
            }
            
            if (targetTab) {
                targetTab.className = 'flex-1 py-3 px-4 text-center bg-blue-500 text-white mobile-tab-active';
            }
            
            // 섹션이 변경되면 스크롤을 맨 위로
            window.scrollTo(0, 0);
        }

        // 화면 크기 변경 감지하여 데스크톱/모바일 모드 전환
        function handleResize() {
            // 강제 모바일 뷰 모드가 아닐 때만 실행
            if (!document.body.classList.contains('force-mobile-view')) {
                if (window.innerWidth >= 1280) {
                    // 데스크톱 모드: 모든 섹션 표시
                    const sections = document.querySelectorAll('.mobile-section');
                    sections.forEach(section => {
                        section.classList.remove('mobile-active');
                    });
                } else {
                    // 모바일 모드: 활성화된 탭만 표시 (기본적으로 목록 탭)
                    const activeSection = document.querySelector('.mobile-section.mobile-active');
                    if (!activeSection) {
                        showMobileTab('list'); // 기본적으로 목록 탭 활성화
                    }
                }
            }
        }

        // 스와이프 힌트 표시 함수
        function showSwipeHint() {
            // 모바일 환경이 아니고 강제 모바일 뷰도 아니면 실행하지 않음
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            // 이미 힌트를 본 적이 있으면 표시하지 않음
            if (localStorage.getItem('swipe_hint_shown')) return;
            
            const hint = document.createElement('div');
            hint.className = 'swipe-hint';
            hint.innerHTML = '← 좌우 스와이프로 탭 이동 →';
            
            document.body.appendChild(hint);
            
            // 3초 후 힌트 제거
            setTimeout(() => {
                if (hint.parentNode) {
                    hint.remove();
                }
            }, 3000);
            
            // 힌트 표시 완료 기록
            localStorage.setItem('swipe_hint_shown', 'true');
        }

        // 모바일 뷰 테스트 토글 (개발자용)
        function toggleMobileView() {
            const body = document.body;
            const testBtn = document.getElementById('mobileTestBtn');
            
            if (body.classList.contains('force-mobile-view')) {
                // 모바일 뷰 해제
                body.classList.remove('force-mobile-view');
                testBtn.textContent = '📱 모바일 뷰 테스트';
                testBtn.className = 'text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors';
                
                // 모든 섹션 표시
                const sections = document.querySelectorAll('.mobile-section');
                sections.forEach(section => {
                    section.classList.remove('mobile-active');
                });
            } else {
                // 모바일 뷰 강제 활성화
                body.classList.add('force-mobile-view');
                testBtn.textContent = '💻 데스크톱 뷰 복원';
                testBtn.className = 'text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors';
                
                // 목록 탭을 기본으로 활성화
                showMobileTab('list');
            }
        }

        // 초기화 및 자동 저장/로드 기능 설정
        document.addEventListener('DOMContentLoaded', async function() {
            // Firebase 연결 테스트 실행
            setTimeout(async () => {
                await testFirebaseConnection();
            }, 1000); // 1초 후 테스트 실행
            
            // 모바일 탭 네비게이션 초기화
            handleResize(); // 초기 화면 크기에 따른 모드 설정
            window.addEventListener('resize', handleResize); // 화면 크기 변경 감지
            
            // 스와이프 제스처 이벤트 리스너 등록
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.addEventListener('touchstart', handleTouchStart, { passive: false });
                mainContent.addEventListener('touchmove', handleTouchMove, { passive: false });
                mainContent.addEventListener('touchend', handleTouchEnd, { passive: true });
                console.log('👆 스와이프 제스처 이벤트 리스너 등록 완료');
            }
            
            // 모바일 환경에서 스와이프 힌트 표시 (3초 후)
            setTimeout(() => {
                showSwipeHint();
            }, 3000);
            
            setupInputPlaceholders(); // Tab 키 기능 설정
            renderChecklist(); // 체크리스트 초기 렌더링
            setupChecklistEnterKey(); // 체크리스트 엔터 키 설정
            setupNumberFormatting(); // 숫자 포맷팅 설정
            loadFormDataFromLocalStorage(); // 페이지 로드 시 localStorage에서 데이터 불러오기
            updateSettlementListUI(); // 페이지 로드 시 정산서 목록 UI 초기화
            // 모든 입력 필드에 input 이벤트 리스너 추가하여 데이터 변경 시 자동 저장
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                element.addEventListener('input', () => {
                    saveFormDataToLocalStorage();
                    generateDocument(); // 입력 시 미리보기 자동 업데이트
                });
                element.addEventListener('change', () => { // select, date, checkbox 등 변경 시
                    saveFormDataToLocalStorage();
                    generateDocument(); // 변경 시 미리보기 자동 업데이트
                });
            });
            
            // 만기일, 퇴실일 변경 시 일수 자동 계산
            document.getElementById('contractEndDate').addEventListener('change', calculateDateDifference);
            document.getElementById('moveOutDate').addEventListener('change', calculateDateDifference);
            
            document.getElementById('clearFormButton').addEventListener('click', function() {
                console.log('🗑️ 양식 초기화 - 이전 currentSettlementId:', currentSettlementId);
                clearForm();
                currentSettlementId = null; // 현재 편집 중인 정산서 ID 초기화
                console.log('🗑️ 양식 초기화 완료 - 새로운 currentSettlementId:', currentSettlementId);
                updateSettlementListUI(); // 목록 UI 업데이트
            }); // 양식 초기화 버튼
            
            // Ctrl+S 단축키 이벤트 리스너 (폼 제출과 동일하게 작동)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault(); // 브라우저 기본 저장 동작 방지
                    document.getElementById('documentForm').dispatchEvent(new Event('submit'));
                }
            });
            // 폼 제출 시 페이지 새로고침 방지 및 정산서 저장
            document.getElementById('documentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // 정산서 저장
                    const settlementId = await saveCurrentSettlement();
                    
                    // 문서 생성
                    generateDocument();
                    
                    // 모바일에서 저장 후 미리보기 탭으로 자동 전환
                    if (window.innerWidth < 1280) {
                        showMobileTab('preview');
                    }
                    
                    // 성공 메시지 표시
                    const roomName = document.getElementById('documentTitle').value || '미지정';
                    alert(`${roomName} 정산서가 저장되었습니다.`);
                } catch (error) {
                    console.error('폼 제출 중 오류:', error);
                    alert('정산서 저장 중 오류가 발생했습니다.');
                }
            });
        });

    </script>

</body>
</html>