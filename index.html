<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì”ê¸ˆì¼ ì •ì‚°ë‚´ì—­ âœï¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap'); /* ì œëª©ìš© í°íŠ¸ */
        :root {
            /* CSS ë³€ìˆ˜ ê¸°ë³¸ê°’ ì„¤ì • */
            --accent-color: #2563EB; /* ê¸°ë³¸ íŒŒë€ìƒ‰ */
            --accent-color-light: #BFDBFE;
            --accent-color-start: #3B82F6;
            --accent-color-end: #2563EB;
            --header-bg-image: none; /* ê¸°ë³¸ ì´ë¯¸ì§€ ì—†ìŒ */
            --header-bg-position: center center;
            --header-bg-size: 40% auto;
            --header-bg-opacity: 0.15;
            --header-mix-blend-mode: soft-light;
        }
        * {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .material-section {
            break-inside: avoid;
            page-break-inside: avoid;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #ffffff; /* ì„¹ì…˜ ë°°ê²½ìƒ‰ */
            border-radius: 0.75rem; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); /* ì€ì€í•œ ê·¸ë¦¼ì */
        }
        .input-group {
            margin-bottom: 0.5rem;
        }
        .section-divider {
            border-top: 2px solid #e5e7eb;
            margin: 3rem 0; /* ê°„ê²© í™•ëŒ€ */
        }
        .gradient-header-bg {
            /* ì–‘ì‹ëª…ì— ë”°ë¥¸ í…Œë§ˆ ìƒ‰ìƒ ê·¸ë¼ë””ì–¸íŠ¸ (ê¸°ë³¸: blue) */
            background: linear-gradient(135deg, var(--accent-color-start) 0%, var(--accent-color-end) 100%);
            padding: 2.5rem; /* íŒ¨ë”© ì¦ê°€ */
            border-radius: 1rem; /* ë” ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì */
            position: relative; /* ::before ê°€ìƒ ìš”ì†Œì˜ ê¸°ì¤€ì  */
            overflow: hidden; /* ë°°ê²½ ì´ë¯¸ì§€ê°€ ë°•ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
            /* ì¸ì‡„ ì‹œì—ë„ ìƒ‰ìƒ ìœ ì§€ë¥¼ ìœ„í•´ */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        /* í—¤ë” ë°°ê²½ ì´ë¯¸ì§€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ê°€ìƒ ìš”ì†Œ) */
        .gradient-header-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--header-bg-image); /* JSì—ì„œ ì„¤ì •ëœ ì´ë¯¸ì§€ */
            background-repeat: no-repeat;
            background-position: var(--header-bg-position); /* JSì—ì„œ ì„¤ì •ëœ ìœ„ì¹˜ */
            background-size: var(--header-bg-size); /* JSì—ì„œ ì„¤ì •ëœ í¬ê¸° */
            opacity: var(--header-bg-opacity); /* JSì—ì„œ ì„¤ì •ëœ íˆ¬ëª…ë„ */
            z-index: 1; /* ê·¸ë¼ë””ì–¸íŠ¸ ìœ„ì— ì˜¤ë„ë¡ */
            mix-blend-mode: var(--header-mix-blend-mode); /* JSì—ì„œ ì„¤ì •ëœ ë¸”ë Œë”© ëª¨ë“œ */
            /* ì¸ì‡„ ì‹œì—ë„ ìƒ‰ìƒ ìœ ì§€ë¥¼ ìœ„í•´ */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .gradient-header-bg h1, .gradient-header-bg p {
            position: relative; /* í…ìŠ¤íŠ¸ê°€ ì´ë¯¸ì§€ ìœ„ì— ì˜¤ë„ë¡ */
            z-index: 2;
        }
        .accent-border {
            border-left: 5px solid var(--accent-color, #2563EB); /* í…Œë§ˆ ìƒ‰ìƒ ê²½ê³„ì„  */
            padding-left: 1rem;
        }
        /* H2 ë° H3ì— ë™ì¼í•˜ê²Œ ì ìš©ë  ì„¹ì…˜ ì œëª© ìŠ¤íƒ€ì¼ */
        .section-heading, .document-output h2, .document-output h3 {
            font-family: 'Playfair Display', serif !important; /* Playfair Display í°íŠ¸ ê°•ì œ ì ìš© */
            font-weight: 700 !important; /* êµµê²Œ ê°•ì œ ì ìš© */
            color: #1F2937 !important; /* ì§„í•œ íšŒìƒ‰ ê°•ì œ ì ìš© */
            display: flex; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì •ë ¬ */
            align-items: center;
        }
        .section-heading { /* input formì˜ h3ê³¼ output h2ì— ì ìš© */
            border-bottom: 3px solid var(--accent-color-light); /* í…Œë§ˆ ìƒ‰ìƒìœ¼ë¡œ ë°‘ì¤„ */
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section-heading i {
            margin-right: 0.75rem;
            color: var(--accent-color);
            -webkit-print-color-adjust: exact; /* ì¸ì‡„ ì‹œ ìƒ‰ìƒ ìœ ì§€ */
            print-color-adjust: exact;
        }
        /* PDF ìƒì„± ê¸°ëŠ¥ ê´€ë ¨ CSS */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body {
                -webkit-print-color-adjust: exact; /* Chrome, Safari */
                print-color-adjust: exact; /* í‘œì¤€ */
                font-size: 11pt; /* ì¸ì‡„ ì‹œ ê¸€ê¼´ í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
                line-height: 1.6;
                color: #333333;
                background-color: transparent !important; /* ë°°ê²½ìƒ‰ íˆ¬ëª…í•˜ê²Œ */
            }
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            .shadow-lg {
                box-shadow: none !important; /* ì „ì²´ ê·¸ë¦¼ì ì œê±° */
            }
            .document-output { /* ë³´ë„ìë£ŒëŠ” Times New Roman ìœ ì§€ */
                margin: 0;
                padding: 0;
                width: 100%;
                font-family: 'Times New Roman', serif !important; /* ì¸ì‡„ ì‹œ ë¬¸ì„œ ì „ì²´ í°íŠ¸ */
            }
            /* material-sectionì˜ ì™¸ê³½ì„ ê³¼ ê·¸ë¦¼ìë¥¼ ì¸ì‡„ ì‹œì—ë„ ìœ ì§€ */
            .material-section {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important; /* ì¸ì‡„ ì‹œì—ë„ ì—°í•œ ê·¸ë¦¼ì ìœ ì§€ */
                border: 1px solid #e5e7eb !important; /* ì¸ì‡„ ì‹œì—ë„ ì™¸ê³½ì„  ìœ ì§€ */
                padding: 1.5rem !important; /* íŒ¨ë”© ìœ ì§€ */
                margin-bottom: 1.5rem !important; /* ë§ˆì§„ ìœ ì§€ */
                background-color: #ffffff !important; /* ë°°ê²½ìƒ‰ ìœ ì§€ */
                border-radius: 0.5rem !important; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ìœ ì§€ */
                -webkit-print-color-adjust: exact !important; /* ì¤‘ìš”: ë°°ê²½ìƒ‰ ìœ ì§€ */
                print-color-adjust: exact !important; /* ì¤‘ìš”: ë°°ê²½ìƒ‰ ìœ ì§€ */
            }
            /* h2, h3 ì œëª©ì˜ í°íŠ¸ì™€ êµµê¸° ìœ ì§€ */
            .document-output h2, .document-output h3 {
                font-family: 'Playfair Display', serif !important;
                font-weight: 700 !important;
                color: #1F2937 !important;
            }
            .section-heading { /* ì¸ì‡„ ì‹œ ë°‘ì¤„ ë° ë§ˆì§„ ì¬ì¡°ì • */
                border-bottom: 1px solid #ddd !important; /* ì¸ì‡„ ì‹œ ë°‘ì¤„ ì–‡ê²Œ */
                padding-bottom: 0.25rem !important;
                margin-bottom: 1rem !important;
            }
            /* ê·¸ë¼ë””ì–¸íŠ¸ í—¤ë” ë° ìƒ‰ìƒ ìš”ì†Œì˜ ìƒ‰ìƒ ìœ ì§€ */
            .gradient-header-bg {
                /* ë³€ìˆ˜ ê°’ì„ ì§ì ‘ ì‚¬ìš©í•˜ë©° !important ê°•ì œ */
                background: linear-gradient(135deg, var(--accent-color-start) 0%, var(--accent-color-end) 100%) !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color: white !important;
                padding: 1rem !important;
                border-radius: 0.5rem !important;
                text-shadow: none !important;
                border: none !important;
            }
            .gradient-header-bg::before { /* ì¸ì‡„ ì‹œ ë°°ê²½ ì´ë¯¸ì§€ë„ ìœ ì§€ */
                background-image: var(--header-bg-image) !important; /* ë™ì ìœ¼ë¡œ ì„¤ì •ëœ ì´ë¯¸ì§€ ìœ ì§€ */
                background-position: var(--header-bg-position) !important; /* ë™ì ìœ¼ë¡œ ì„¤ì •ëœ ìœ„ì¹˜ ìœ ì§€ */
                background-size: var(--header-bg-size) !important; /* ë™ì ìœ¼ë¡œ ì„¤ì •ëœ í¬ê¸° ìœ ì§€ */
                opacity: 0.05 !important; /* ì¸ì‡„ ì‹œ ë” í¬ë¯¸í•˜ê²Œ */
                mix-blend-mode: normal !important; /* ì¸ì‡„ ì‹œ ë¸”ë Œë”© ëª¨ë“œ ì œê±°í•˜ì—¬ í˜¸í™˜ì„± ê°œì„  */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .accent-border {
                border-left-color: var(--accent-color) !important;
                background-color: #F0F8FF !important; /* ì¸ì‡„ ì‹œì—ë„ ë°°ê²½ìƒ‰ ìœ ì§€ */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        .print-only { display: none; } /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        @page {
            size: A4;
            margin: 1in;
        }
        
        /* ëª¨ë°”ì¼ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        @media (max-width: 1279px) {
            /* ëª¨ë°”ì¼ì—ì„œ ì»¨í…Œì´ë„ˆ íŒ¨ë”© ìµœì í™” */
            .container {
                padding-top: 1rem !important;
                padding-bottom: 5rem !important; /* í•˜ë‹¨ íƒ­ë°” ê³µê°„ í™•ë³´ */
            }
            
            .mobile-section {
                display: none;
            }
            .mobile-section.mobile-active {
                display: block;
            }
            .mobile-tab-active {
                background-color: #3B82F6 !important;
                color: white !important;
            }
            .mobile-tab-inactive {
                background-color: white;
                color: #6B7280;
            }
            .mobile-tab-inactive:hover {
                background-color: #F9FAFB;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œ ë©”ì¸ ì½˜í…ì¸ ë¥¼ í•˜ë‚˜ì˜ ì»¬ëŸ¼ìœ¼ë¡œ ë³€ê²½ */
            #mainContent {
                display: block !important;
            }
            #mainContent > div {
                width: 100% !important;
                margin-bottom: 1rem;
            }
        }
        
        /* ë°ìŠ¤í¬í†±ì—ì„œëŠ” ëª¨ë“  ì„¹ì…˜ì´ ë³´ì´ë„ë¡ */
        @media (min-width: 1280px) {
            .mobile-section {
                display: block !important;
            }
        }
        
        /* ëª¨ë°”ì¼ ë·° í…ŒìŠ¤íŠ¸ ëª¨ë“œ */
        .force-mobile-view #mobileTabNav {
            display: flex !important;
        }
        .force-mobile-view .mobile-section {
            display: none !important;
        }
        .force-mobile-view .mobile-section.mobile-active {
            display: block !important;
        }
        .force-mobile-view #mainContent {
            display: block !important;
        }
        .force-mobile-view #mainContent > div {
            width: 100% !important;
            margin-bottom: 1rem;
        }
        
        /* ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì• ë‹ˆë©”ì´ì…˜ */
        @media (max-width: 1279px) {
            .mobile-section {
                transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            }
            .mobile-section.mobile-active {
                transform: translateX(0);
                opacity: 1;
            }
            .swipe-transition {
                transition: transform 0.2s ease-out;
            }
            
            /* ìŠ¤ì™€ì´í”„ íŒíŠ¸ í‘œì‹œ */
            .swipe-hint {
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 100;
                animation: swipeHintFade 3s ease-in-out;
                pointer-events: none;
            }
            
            @keyframes swipeHintFade {
                0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
                20% { opacity: 1; transform: translateX(-50%) translateY(0); }
                80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8 no-print xl:block hidden">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-alt text-blue-600 mr-3"></i> ì”ê¸ˆì¼ ì •ì‚°ë‚´ì—­
            </h1>
            <p class="text-gray-600 text-lg">ëª‡ ê°€ì§€ ì •ë³´ë§Œ ì…ë ¥í•˜ë©´ ì „ë¬¸ì ì¸ ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œê°€ ì™„ì„±ë©ë‹ˆë‹¤</p>
            
            <!-- Firebase ì—°ê²° ìƒíƒœ í‘œì‹œ -->
            <div id="firebaseStatus" class="mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <span>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸ ì¤‘...</span>
            </div>
            
            <!-- ê°œë°œììš© ëª¨ë°”ì¼ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (ë°ìŠ¤í¬í†±ì—ì„œë§Œ í‘œì‹œ) -->
            <div class="mt-2 hidden xl:block">
                <button id="mobileTestBtn" onclick="toggleMobileView()" class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                    ğŸ“± ëª¨ë°”ì¼ ë·° í…ŒìŠ¤íŠ¸
                </button>
            </div>
        </div>
        
        <!-- ëª¨ë°”ì¼ ì „ìš© ê°„ì†Œí™”ëœ í—¤ë” -->
        <div class="xl:hidden mb-4 no-print">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-file-alt text-blue-600 mr-2"></i> ì”ê¸ˆì •ì‚°ì„œ
                </h1>
                <!-- Firebase ì—°ê²° ìƒíƒœ (ëª¨ë°”ì¼ìš© ì•„ì´ì½˜ë§Œ) -->
                <div id="mobileFirebaseStatus" class="text-xs">
                    <i class="fas fa-spinner fa-spin text-gray-500"></i>
                </div>
            </div>
        </div>
        
        <!-- ëª¨ë°”ì¼ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="xl:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50" id="mobileTabNav">
            <div class="flex">
                <button onclick="showMobileTab('list')" id="tab-list" class="flex-1 py-3 px-4 text-center bg-blue-500 text-white">
                    <i class="fas fa-list block mb-1"></i>
                    <span class="text-xs">ëª©ë¡</span>
                </button>
                <button onclick="showMobileTab('input')" id="tab-input" class="flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-edit block mb-1"></i>
                    <span class="text-xs">ì…ë ¥</span>
                </button>
                <button onclick="showMobileTab('preview')" id="tab-preview" class="flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-file-alt block mb-1"></i>
                    <span class="text-xs">ë¯¸ë¦¬ë³´ê¸°</span>
                </button>
            </div>
        </div>
        
        
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4" id="mainContent">
            <div id="listSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-6 no-print mobile-section mobile-active">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-list text-blue-500 mr-2"></i>
                    ì €ì¥ëœ ì •ì‚°ì„œ ëª©ë¡
                </h2>
                <div id="settlementList" class="space-y-3">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>ì €ì¥ëœ ì •ì‚°ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm">ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œë¥¼ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            
            <div id="inputSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-6 no-print mobile-section">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-edit text-blue-500 mr-2"></i>
                        ì •ë³´ ì…ë ¥
                    </h2>
                    <div class="flex space-x-1">
                        <button type="submit" form="documentForm" class="bg-green-600 text-white py-2 px-2 rounded-md hover:bg-green-700 transition duration-300 font-medium text-xs">
                            <i class="fas fa-save mr-1"></i>
                            ì €ì¥
                        </button>
                        <button type="button" id="clearFormButton" class="bg-gray-300 text-gray-800 py-2 px-2 rounded-md hover:bg-gray-400 transition duration-300 font-medium text-xs">
                            <i class="fas fa-trash-alt mr-1"></i>
                            ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
                <form id="documentForm" class="space-y-6">
                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-info-circle"></i> ê¸°ë³¸ ì •ë³´
                        </h3>
                        
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="documentTitle">í˜¸ì‹¤ëª…*</label>
                            <input type="text" id="documentTitle" required class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="settlementDate">ì”ê¸ˆì¼</label>
                            <input type="date" id="settlementDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="managementRequestDate">ê´€ë¦¬ë¹„ì •ì‚°ìš”ì²­ì¼</label>
                            <input type="date" id="managementRequestDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="documentVersion">í‡´ì‹¤ì ê²€ì¼ì •</label>
                            <input type="datetime-local" id="documentVersion" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group flex items-center mb-4">
                            <label class="text-sm font-medium text-gray-700 w-32 mr-4" for="releaseDate">ì…ì£¼ì ê²€ì¼ì •</label>
                            <input type="datetime-local" id="releaseDate" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="input-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="depositAccount">ë³´ì¦ê¸ˆë°˜í™˜ê³„ì¢Œ</label>
                            <textarea id="depositAccount" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                        </div>
                        <div class="input-group mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="managementFeeAccount">ê´€ë¦¬ë¹„ìŠ¹ê³„ê³„ì¢Œ</label>
                            <textarea id="managementFeeAccount" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 resize-vertical"></textarea>
                        </div>
                    </div>

                    <div class="border-b border-gray-200 pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-calculator"></i> ì •ì‚° ê¸ˆì•¡ì •ë³´
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="depositReturn">ë³´ì¦ê¸ˆ ë°˜í™˜ê¸ˆ</label>
                                <input type="text" id="depositReturn" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="longTermRepair">ì¥ê¸°ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ</label>
                                <input type="text" id="longTermRepair" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="managementFee">ê´€ë¦¬ë¹„</label>
                                <input type="text" id="managementFee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="utilityFee">ê³µê³¼ê¸ˆ</label>
                                <input type="text" id="utilityFee" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="monthlyRent">ì›”ì„¸</label>
                                <input type="text" id="monthlyRent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="rentDays">ì¼ìˆ˜ (ìë™ê³„ì‚°)</label>
                                <input type="number" id="rentDays" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-100" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="contractEndDate">ë§Œê¸°ì¼</label>
                                <input type="date" id="contractEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="input-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="moveOutDate">í‡´ì‹¤ì¼</label>
                                <input type="date" id="moveOutDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div class="flex items-center">
                                <input type="radio" id="overpaid" name="rentType" value="overpaid" class="mr-2">
                                <label for="overpaid" class="text-sm font-medium text-gray-700">ê³¼ë‚© (ë°˜í™˜ +)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="radio" id="unpaid" name="rentType" value="unpaid" class="mr-2">
                                <label for="unpaid" class="text-sm font-medium text-gray-700">ë¯¸ë‚© (ë°˜í™˜ -)</label>
                            </div>
                        </div>
                    </div>

                    <div class="pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-check-circle"></i> ì”ê¸ˆì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸
                        </h3>
                        <div id="checklistContainer" class="space-y-2">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ -->
                        </div>
                        <div class="mt-4 flex space-x-2">
                            <input type="text" id="newChecklistItem" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" onclick="addChecklistItem()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-300">
                                <i class="fas fa-plus mr-1"></i>ì¶”ê°€
                            </button>
                        </div>
                    </div>

                    <div class="pb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 section-heading">
                            <i class="fas fa-sticky-note"></i> ë©”ëª¨
                        </h3>
                        <textarea id="memoText" class="w-full px-3 py-3 border-2 border-purple-400 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 resize-vertical min-h-[100px]" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    
                </form>
            </div>
            <div id="previewSection" class="xl:col-span-4 bg-white rounded-lg border-2 border-black p-8 mobile-section">
                <div class="flex items-center justify-between mb-6 no-print">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-file-alt text-green-600 mr-2"></i>
                        ìƒì„±ëœ ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œ
                    </h2>
                    <button onclick="printDocument()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-300">
                        <i class="fas fa-print mr-2"></i>
                        PDF ì €ì¥
                    </button>
                </div>
                <div id="documentPreview" class="document-output">
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-clipboard-list text-6xl mb-4"></i>
                        <p class="text-lg">ì¢Œì¸¡ ì–‘ì‹ì„ ì‘ì„±í•˜ê³  "ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œ ìƒì„±í•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyCb0u5luDHd3rXzK2lfx4wdF_LmpvFLFs4",
            authDomain: "settlement-manager.firebaseapp.com",
            projectId: "settlement-manager",
            storageBucket: "settlement-manager.firebasestorage.app",
            messagingSenderId: "73939961165",
            appId: "1:73939961165:web:9bb4607a9c4c5b73f9e304"
        };

        // Firebase ì´ˆê¸°í™” (í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ - Firebase ìš°ì„ , ì‹¤íŒ¨ì‹œ localStorage)
        let db = null;
        let settlementsCollection = null;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            settlementsCollection = db.collection('settlements');
            useFirebase = true;
            console.log('âœ… Firebase ì—°ê²° ì„±ê³µ - í´ë¼ìš°ë“œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©');
        } catch (error) {
            console.log('âŒ Firebase ì—°ê²° ì‹¤íŒ¨, localStorage ì‚¬ìš©:', error);
            useFirebase = false;
        }

        // ê¸°ì¡´ ë³€ìˆ˜ë“¤
        const formId = 'documentForm'; // í¼ ID
        const localStorageKeyPrefix = 'form_generator_'; // localStorage í‚¤ ì ‘ë‘ì‚¬
        const settlementListKey = 'settlement_documents_list'; // ì •ì‚°ì„œ ëª©ë¡ í‚¤ (ë°±ì—…ìš©)
        let currentSettlementId = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì •ì‚°ì„œ ID
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬
        let checklistItems = [
            'ì€í–‰ëŒ€ì¶œê¸ˆ ë° ë‚¨ì€ ì”ê¸ˆ, ì›”ì„¸ ì…ê¸ˆ í™•ì¸',
            'í‡´ì‹¤ ì„¸ì…ì ê´€ë¦¬ë¹„ ë‚©ë¶€ í™•ì¸',
            'í‡´ì‹¤ ì„¸ì…ì ì¸í„°ë„·, ë„ì‹œê°€ìŠ¤ ë“± ê³µê³¼ê¸ˆ ë‚©ë¶€ í™•ì¸',
            'ê´€ë¦¬ë¹„ ìŠ¹ê³„ ì—¬ë¶€ í™•ì¸',
            'ë³´ì¦ê¸ˆ ë°˜í™˜ í›„ ê³µë™í˜„ê´€/í˜¸ì‹¤ ë¹„ë°€ë²ˆí˜¸ í™•ì¸'
        ];
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í•¨ìˆ˜
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = checklistItems.map((item, index) => `
                <div class="flex items-start group">
                    <input type="checkbox" id="check${index + 1}" class="mt-1 mr-2 accent-color-checkbox" onchange="saveFormDataToLocalStorage(); generateDocument();">
                    <label for="check${index + 1}" class="text-gray-700 flex-1">${index + 1}. ${item}</label>
                    <button type="button" onclick="removeChecklistItem(${index})" class="ml-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€
        function addChecklistItem() {
            const input = document.getElementById('newChecklistItem');
            const newItem = input.value.trim();
            if (newItem) {
                checklistItems.push(newItem);
                input.value = '';
                renderChecklist();
                saveFormDataToLocalStorage();
                generateDocument();
            }
        }
        
        // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚­ì œ
        function removeChecklistItem(index) {
            if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                checklistItems.splice(index, 1);
                renderChecklist();
                saveFormDataToLocalStorage();
                generateDocument();
            }
        }
        
        // Enter í‚¤ë¡œ ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì¶”ê°€
        function setupChecklistEnterKey() {
            document.getElementById('newChecklistItem').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addChecklistItem();
                }
            });
        }
        
        // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜ (ì‰¼í‘œ ì¶”ê°€)
        function formatNumberInput(value) {
            // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
            const numericValue = value.replace(/[^\d]/g, '');
            // ì‰¼í‘œ ì¶”ê°€
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // ìˆ«ì ì…ë ¥ í•„ë“œì—ì„œ ì‰¼í‘œ ì œê±°í•œ ìˆœìˆ˜ ìˆ«ì ê°’ ë°˜í™˜
        function getNumericValue(formattedValue) {
            return formattedValue.replace(/,/g, '');
        }
        
        // ê¸ˆì•¡ ì…ë ¥ í•„ë“œì— í¬ë§·íŒ… ì´ë²¤íŠ¸ ì„¤ì •
        function setupNumberFormatting() {
            const numberInputs = [
                'depositReturn', 'longTermRepair', 'managementFee', 
                'utilityFee', 'monthlyRent'
            ];
            
            numberInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // input ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ í¬ë§·íŒ…
                    input.addEventListener('input', function(e) {
                        const cursorPosition = e.target.selectionStart;
                        const originalLength = e.target.value.length;
                        
                        const formatted = formatNumberInput(e.target.value);
                        e.target.value = formatted;
                        
                        // ì»¤ì„œ ìœ„ì¹˜ ì¡°ì • (ì‰¼í‘œ ì¶”ê°€ë¡œ ì¸í•œ ìœ„ì¹˜ ë³€ê²½ ë³´ì •)
                        const newLength = formatted.length;
                        const lengthDiff = newLength - originalLength;
                        const newPosition = cursorPosition + lengthDiff;
                        
                        e.target.setSelectionRange(newPosition, newPosition);
                    });
                    
                    // paste ì´ë²¤íŠ¸ ì²˜ë¦¬
                    input.addEventListener('paste', function(e) {
                        setTimeout(() => {
                            e.target.value = formatNumberInput(e.target.value);
                        }, 0);
                    });
                }
            });
        }
        
        
        // ì €ì¥ ì•Œë¦¼ í† ìŠ¤íŠ¸ í•¨ìˆ˜
        function showSaveNotification(message) {
            // ê¸°ì¡´ ì•Œë¦¼ì´ ìˆë‹¤ë©´ ì œê±°
            const existingNotification = document.getElementById('saveNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // í† ìŠ¤íŠ¸ ì•Œë¦¼ ìƒì„±
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md shadow-lg z-50 transform transition-all duration-300 translate-x-full';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // í•˜ì´ë¸Œë¦¬ë“œ ì •ì‚°ì„œ ê´€ë¦¬ í•¨ìˆ˜ë“¤ (Firebase ìš°ì„ , ì‹¤íŒ¨ì‹œ localStorage)
        async function getSettlementList() {
            if (useFirebase) {
                try {
                    const snapshot = await settlementsCollection.orderBy('updatedAt', 'desc').get();
                    const settlements = [];
                    snapshot.forEach(doc => {
                        settlements.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Firebase ë°ì´í„°ë¥¼ localStorageì— ë°±ì—…
                    localStorage.setItem(settlementListKey, JSON.stringify(settlements));
                    
                    console.log(`ğŸ“Š Firebaseì—ì„œ ${settlements.length}ê°œ ì •ì‚°ì„œ ë¡œë“œë¨`);
                    return settlements;
                } catch (error) {
                    console.log('Firebase ì½ê¸° ì‹¤íŒ¨, localStorage ì‚¬ìš©:', error);
                }
            }
            
            // Firebase ì‹¤íŒ¨í•˜ê±°ë‚˜ ë¹„í™œì„±í™”ì‹œ localStorage ì‚¬ìš©
            const stored = localStorage.getItem(settlementListKey);
            const list = stored ? JSON.parse(stored) : [];
            console.log(`ğŸ’¾ localStorageì—ì„œ ${list.length}ê°œ ì •ì‚°ì„œ ë¡œë“œë¨`);
            return list.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
        }
        
        async function saveSettlement(settlementData) {
            if (useFirebase) {
                try {
                    let savedId;
                    
                    // ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì—¬ë¶€ íŒë‹¨ - currentSettlementIdê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    if (currentSettlementId) {
                        console.log('ğŸ”„ ê¸°ì¡´ ì •ì‚°ì„œ ì—…ë°ì´íŠ¸:', currentSettlementId);
                        
                        // currentSettlementIdê°€ localStorage IDì¸ ê²½ìš° Firebaseì—ì„œ ì°¾ê¸°
                        if (currentSettlementId.startsWith('settlement_')) {
                            console.log('ğŸ”„ localStorage ID ì²˜ë¦¬ ì¤‘, í˜„ì¬ ì •ì‚°ì„œ ì •ë³´:', {
                                roomName: settlementData.roomName,
                                settlementDate: settlementData.settlementDate
                            });
                            
                            // localStorageì—ì„œ ë¶ˆëŸ¬ì˜¨ ì •ì‚°ì„œëŠ” localStorageì—ì„œ ì§ì ‘ ì—…ë°ì´íŠ¸
                            settlementData.id = currentSettlementId;
                            saveSettlementToLocalStorage(settlementData);
                            savedId = currentSettlementId;
                            
                            // Firebaseì—ë„ ë™ì¼í•œ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ë¬´ì‹œ
                            try {
                                const snapshot = await settlementsCollection
                                    .where('roomName', '==', settlementData.roomName)
                                    .where('settlementDate', '==', settlementData.settlementDate)
                                    .get();
                                
                                if (!snapshot.empty) {
                                    // ê¸°ì¡´ Firebase ë¬¸ì„œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                                    const firebaseDoc = snapshot.docs[0];
                                    await settlementsCollection.doc(firebaseDoc.id).set({
                                        ...settlementData,
                                        id: firebaseDoc.id // Firebase ID ìœ ì§€
                                    });
                                    console.log('ğŸ”„ Firebase ë¬¸ì„œë„ ì—…ë°ì´íŠ¸:', firebaseDoc.id);
                                } else {
                                    console.log('ğŸ”„ Firebaseì— í•´ë‹¹ ë¬¸ì„œ ì—†ìŒ, localStorageë§Œ ì—…ë°ì´íŠ¸');
                                }
                            } catch (error) {
                                console.log('Firebase ë™ê¸°í™” ì‹¤íŒ¨, localStorageë§Œ ì—…ë°ì´íŠ¸:', error);
                            }
                        } else {
                            // ì´ë¯¸ Firebase IDì¸ ê²½ìš° ì§ì ‘ ì—…ë°ì´íŠ¸
                            await settlementsCollection.doc(currentSettlementId).set(settlementData);
                            savedId = currentSettlementId;
                        }
                    } else {
                        // ìƒˆ ë¬¸ì„œ ìƒì„±
                        console.log('âœ¨ ìƒˆ ì •ì‚°ì„œ ìƒì„±');
                        const docRef = await settlementsCollection.add(settlementData);
                        savedId = docRef.id;
                    }
                    
                    // localStorage ID ì—…ë°ì´íŠ¸ì˜ ê²½ìš°ì—ëŠ” ì´ë¯¸ localStorage ì €ì¥ì´ ì™„ë£Œë¨
                    if (!currentSettlementId || !currentSettlementId.startsWith('settlement_')) {
                        // Firebase ì €ì¥ ì„±ê³µì‹œ localStorageì—ë„ ë°±ì—… (localStorage IDê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
                        settlementData.id = savedId;
                        saveSettlementToLocalStorage(settlementData);
                    }
                    
                    console.log('ğŸ’¾ Firebaseì™€ localStorageì— ì €ì¥ ì™„ë£Œ, ID:', savedId);
                    return savedId;
                } catch (error) {
                    console.log('Firebase ì €ì¥ ì‹¤íŒ¨, localStorageë¡œ ëŒ€ì²´:', error);
                }
            }
            
            // Firebase ì‹¤íŒ¨ì‹œ ë˜ëŠ” ë¹„í™œì„±í™”ì‹œ localStorage ì‚¬ìš©
            console.log('ğŸ’¾ localStorageì— ì €ì¥');
            return saveSettlementToLocalStorage(settlementData);
        }
        
        
        // ë°±ì—…ìš© localStorage í•¨ìˆ˜ë“¤
        function getSettlementListFromLocalStorage() {
            const stored = localStorage.getItem(settlementListKey);
            return stored ? JSON.parse(stored) : [];
        }
        
        function saveSettlementToLocalStorage(settlementData) {
            let list = getSettlementListFromLocalStorage();
            const existingIndex = list.findIndex(item => item.id === settlementData.id);
            
            if (existingIndex >= 0) {
                list[existingIndex] = settlementData;
            } else {
                if (!settlementData.id) {
                    settlementData.id = generateSettlementId();
                }
                list.push(settlementData);
            }
            
            localStorage.setItem(settlementListKey, JSON.stringify(list));
            return settlementData.id;
        }
        
        function generateSettlementId() {
            return 'settlement_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        async function saveCurrentSettlement() {
            console.log('ğŸ’¾ ì €ì¥ ì‹œì‘ - currentSettlementId:', currentSettlementId);
            
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ë„ ì €ì¥
            formData.checklistItems = checklistItems;
            
            const roomName = document.getElementById('documentTitle').value || 'ë¯¸ì§€ì •';
            const settlementDate = document.getElementById('settlementDate').value;
            const createdAt = new Date().toISOString();
            
            const settlementData = {
                id: currentSettlementId || generateSettlementId(),
                roomName: roomName,
                settlementDate: settlementDate,
                createdAt: currentSettlementId ? undefined : createdAt, // ê¸°ì¡´ ë¬¸ì„œë©´ ìƒì„±ì¼ ìœ ì§€
                updatedAt: createdAt,
                formData: formData
            };
            
            console.log('ğŸ’¾ ì €ì¥í•  ë°ì´í„°:', {
                isUpdate: !!currentSettlementId,
                id: settlementData.id,
                roomName: settlementData.roomName
            });
            
            // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ createdAt ìœ ì§€
            if (currentSettlementId) {
                try {
                    // ë¨¼ì € ê¸°ì¡´ ì •ì‚°ì„œ ëª©ë¡ì—ì„œ ì°¾ê¸°
                    const existingList = await getSettlementList();
                    const existing = existingList.find(item => item.id === currentSettlementId);
                    if (existing && existing.createdAt) {
                        settlementData.createdAt = existing.createdAt;
                    } else {
                        settlementData.createdAt = createdAt;
                    }
                } catch (error) {
                    console.error('ê¸°ì¡´ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', error);
                    settlementData.createdAt = createdAt;
                }
            } else {
                settlementData.createdAt = createdAt;
            }
            
            const savedId = await saveSettlement(settlementData);
            currentSettlementId = savedId;
            updateSettlementListUI();
            
            return savedId;
        }
        
        async function loadSettlement(id) {
            try {
                console.log('ğŸ“ ì •ì‚°ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘ - ID:', id);
                
                // í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹ìœ¼ë¡œ ì •ì‚°ì„œ ëª©ë¡ì—ì„œ ì°¾ê¸°
                const list = await getSettlementList();
                const settlement = list.find(item => item.id === id);
                
                if (settlement) {
                    currentSettlementId = id;
                    console.log('ğŸ“ currentSettlementId ì„¤ì •:', currentSettlementId);
                    const formData = settlement.formData;
                    
                    // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ ë¡œë“œ
                    if (formData.checklistItems) {
                        checklistItems = formData.checklistItems;
                        renderChecklist();
                    }
                    
                    // í¼ì— ë°ì´í„° ë¡œë“œ
                    for (const elementId in formData) {
                        if (elementId === 'checklistItems') continue; // ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ë³„ë„ ì²˜ë¦¬ë¨
                        const element = document.getElementById(elementId);
                        if (element) {
                            if (element.type === 'checkbox' || element.type === 'radio') {
                                element.checked = formData[elementId];
                            } else {
                                element.value = formData[elementId];
                            }
                        }
                    }
                    
                    generateDocument();
                    updateSettlementListUI(); // UI ì—…ë°ì´íŠ¸
                    
                    // ëª¨ë°”ì¼ì—ì„œ ì •ì‚°ì„œ ë¡œë“œ ì‹œ ì…ë ¥ íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
                    if (window.innerWidth < 1280) {
                        showMobileTab('input');
                    }
                    
                    console.log('ğŸ“„ ì •ì‚°ì„œ ë¡œë“œ ì™„ë£Œ:', settlement.roomName || 'ë¯¸ì§€ì •');
                } else {
                    console.error('ì •ì‚°ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', id);
                    alert('ì •ì‚°ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì •ì‚°ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì •ì‚°ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function deleteSettlement(id) {
            console.log('ğŸ—‘ï¸ ì‚­ì œ ìš”ì²­ - ID:', id);
            
            if (confirm('ì •ë§ë¡œ ì´ ì •ì‚°ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    console.log('ğŸ—‘ï¸ ì‚­ì œ í™•ì¸ë¨, ì‚­ì œ ì‹œì‘');
                    
                    // Firebaseì—ì„œ ì‚­ì œ ì‹œë„
                    if (useFirebase) {
                        try {
                            if (id.startsWith('settlement_')) {
                                console.log('ğŸ—‘ï¸ localStorage IDì´ë¯€ë¡œ Firebaseì—ì„œ ë§¤ì¹­ë˜ëŠ” ë¬¸ì„œ ì°¾ì•„ì„œ ì‚­ì œ');
                                // localStorage IDì¸ ê²½ìš°, ê°™ì€ ë°ì´í„°ë¥¼ ê°€ì§„ Firebase ë¬¸ì„œ ì°¾ê¸°
                                const list = await getSettlementList();
                                const settlement = list.find(item => item.id === id);
                                if (settlement) {
                                    // Firebaseì—ì„œ ê°™ì€ roomNameê³¼ settlementDateë¥¼ ê°€ì§„ ë¬¸ì„œë“¤ ì°¾ê¸°
                                    const snapshot = await settlementsCollection
                                        .where('roomName', '==', settlement.roomName)
                                        .where('settlementDate', '==', settlement.settlementDate)
                                        .get();
                                    
                                    // Firebase ë¬¸ì„œë“¤ ì‚­ì œ
                                    const deletePromises = [];
                                    snapshot.forEach(doc => {
                                        console.log('ğŸ—‘ï¸ Firebase ë¬¸ì„œ ì‚­ì œ:', doc.id);
                                        deletePromises.push(settlementsCollection.doc(doc.id).delete());
                                    });
                                    
                                    await Promise.all(deletePromises);
                                    console.log('ğŸ—‘ï¸ Firebaseì—ì„œ ê´€ë ¨ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ');
                                }
                            } else {
                                console.log('ğŸ—‘ï¸ Firebase IDë¡œ ì§ì ‘ ì‚­ì œ:', id);
                                await settlementsCollection.doc(id).delete();
                                console.log('ğŸ—‘ï¸ Firebaseì—ì„œ ì‚­ì œ ì™„ë£Œ');
                            }
                        } catch (error) {
                            console.log('Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
                        }
                    }
                    
                    // localStorageì—ì„œë„ ì‚­ì œ
                    console.log('ğŸ—‘ï¸ localStorageì—ì„œ ì‚­ì œ ì‹œë„');
                    let list = getSettlementListFromLocalStorage();
                    console.log('ğŸ—‘ï¸ ì‚­ì œ ì „ ëª©ë¡ ê°œìˆ˜:', list.length);
                    list = list.filter(item => item.id !== id);
                    console.log('ğŸ—‘ï¸ ì‚­ì œ í›„ ëª©ë¡ ê°œìˆ˜:', list.length);
                    localStorage.setItem(settlementListKey, JSON.stringify(list));
                    
                    if (currentSettlementId === id) {
                        console.log('ğŸ—‘ï¸ í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì •ì‚°ì„œ ì‚­ì œë¨, í¼ ì´ˆê¸°í™”');
                        currentSettlementId = null;
                        clearForm(); // í˜„ì¬ í¸ì§‘ ì¤‘ì´ë˜ ì •ì‚°ì„œë¥¼ ì‚­ì œí–ˆë‹¤ë©´ í¼ë„ ì´ˆê¸°í™”
                    }
                    
                    console.log('ğŸ—‘ï¸ UI ì—…ë°ì´íŠ¸ ì‹œì‘');
                    await updateSettlementListUI();
                    console.log('ğŸ—‘ï¸ ì •ì‚°ì„œ ì‚­ì œ ì™„ë£Œ');
                    
                    // ì‚­ì œ ì„±ê³µ ë©”ì‹œì§€
                    alert('ì •ì‚°ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.error('ì •ì‚°ì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ì •ì‚°ì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            } else {
                console.log('ğŸ—‘ï¸ ì‚­ì œ ì·¨ì†Œë¨');
            }
        }
        
        async function updateSettlementListUI() {
            console.log('ğŸ”„ ëª©ë¡ UI ì—…ë°ì´íŠ¸ ì‹œì‘');
            const list = await getSettlementList();
            console.log('ğŸ”„ ë¶ˆëŸ¬ì˜¨ ëª©ë¡ ê°œìˆ˜:', list.length);
            const listDiv = document.getElementById('settlementList');
            
            if (list.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-inbox text-4xl mb-4"></i>
                        <p>ì €ì¥ëœ ì •ì‚°ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm">ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œë¥¼ ìƒì„±í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }
            
            // ì”ê¸ˆì¼ìˆœ ì •ë ¬ (ë¹ ë¥¸ìˆœ)
            list.sort((a, b) => {
                const dateA = a.settlementDate ? new Date(a.settlementDate) : new Date('9999-12-31'); // ì”ê¸ˆì¼ì´ ì—†ìœ¼ë©´ ë§¨ ë’¤ë¡œ
                const dateB = b.settlementDate ? new Date(b.settlementDate) : new Date('9999-12-31');
                return dateA - dateB; // ì˜¤ë¦„ì°¨ìˆœ (ë¹ ë¥¸ ë‚ ì§œê°€ ë¨¼ì €)
            });
            
            listDiv.innerHTML = list.map(settlement => {
                const isCurrentlyEditing = currentSettlementId === settlement.id;
                const updatedDate = new Date(settlement.updatedAt).toLocaleDateString('ko-KR');
                const settlementDisplayDate = settlement.settlementDate ? 
                    new Date(settlement.settlementDate).toLocaleDateString('ko-KR') : 'ë¯¸ì •';
                
                // ìƒì„¸ ì •ë³´ ì¶”ì¶œ
                const formData = settlement.formData || {};
                const depositReturn = parseInt(formData.depositReturn || 0);
                const longTermRepair = parseInt(formData.longTermRepair || 0);
                const monthlyRent = parseInt(formData.monthlyRent || 0);
                const rentDays = parseInt(formData.rentDays || 0);
                const managementFee = parseInt(formData.managementFee || 0);
                const utilityFee = parseInt(formData.utilityFee || 0);
                
                // ì›”ì„¸ ì¼í• ê³„ì‚°
                const dailyRentCalculation = Math.round((monthlyRent * rentDays * 12) / 365);
                const isOverpaid = formData.overpaid;
                const isUnpaid = formData.unpaid;
                
                // ë°˜í™˜ê¸ˆí•©ê³„ (ì›”ì„¸ ì œì™¸)
                let totalRefund = depositReturn + longTermRepair;
                
                // ì›”ì„¸í¬í•¨ë°˜í™˜ê¸ˆ ê³„ì‚°
                let totalRefundWithRent = totalRefund;
                if (isOverpaid) totalRefundWithRent += dailyRentCalculation;
                else if (isUnpaid) totalRefundWithRent -= dailyRentCalculation;
                
                // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
                const formatKRW = (num) => `${num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}ì›`;
                
                return `
                    <div class="border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors ${isCurrentlyEditing ? 'bg-blue-50 border-blue-300' : ''} mb-3">
                        <div class="p-3">
                            <div class="flex flex-col">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold text-gray-800 flex items-center text-sm">
                                        ${isCurrentlyEditing ? '<i class="fas fa-edit text-blue-500 mr-2"></i>' : '<i class="fas fa-file-alt text-gray-500 mr-2"></i>'}
                                        ${settlement.roomName}
                                    </h3>
                                    ${isCurrentlyEditing ? '<span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full">í¸ì§‘ì¤‘</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-600 mb-2">
                                    <div>ì”ê¸ˆì¼: ${settlementDisplayDate}</div>
                                    <div>ë°˜í™˜ê¸ˆ: ${formatKRW(totalRefund)}</div>
                                </div>
                                <div class="flex space-x-1" onclick="event.stopPropagation()">
                                    ${!isCurrentlyEditing ? `
                                        <button onclick="loadSettlement('${settlement.id}')" class="flex-1 bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600 transition-colors">
                                            <i class="fas fa-edit mr-1"></i>ë¶ˆëŸ¬ì˜¤ê¸°
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteSettlement('${settlement.id}')" class="flex-1 bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600 transition-colors">
                                        <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        
        function printDocument() {
            const roomName = document.getElementById('documentTitle').value || 'ì •ì‚°ì„œ';
            const settlementDate = document.getElementById('settlementDate').value;
            
            // íŒŒì¼ëª… ìƒì„± (ë„ì–´ì“°ê¸° ì œê±° ë° íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
            let fileName = roomName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9ê°€-í£_-]/g, '');
            if (settlementDate) {
                const dateStr = settlementDate.replace(/-/g, '');
                fileName += '_' + dateStr;
            }
            fileName += '_ì”ê¸ˆì •ì‚°ì„œ';
            
            // ë¸Œë¼ìš°ì € ì œëª©ì„ íŒŒì¼ëª…ìœ¼ë¡œ ì„ì‹œ ë³€ê²½
            const originalTitle = document.title;
            document.title = fileName;
            
            // ì¸ì‡„ ì‹¤í–‰
            window.print();
            
            // ì œëª© ë³µì› (ì¸ì‡„ í›„)
            setTimeout(() => {
                document.title = originalTitle;
            }, 1000);
        }
        
        // ëª¨ë“  ì…ë ¥ í•„ë“œì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ì—¬ localStorageì— ì €ì¥
        function saveFormDataToLocalStorage() {
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) { // IDê°€ ìˆëŠ” ìš”ì†Œë§Œ ì €ì¥
                    if (element.type === 'checkbox') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ë„ ì €ì¥
            formData.checklistItems = checklistItems;
            localStorage.setItem(localStorageKeyPrefix + formId, JSON.stringify(formData));
            // console.log('Form data saved to localStorage');
        }
        // localStorageì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì…ë ¥ í•„ë“œì— ì±„ì›€
        function loadFormDataFromLocalStorage() {
            const savedData = localStorage.getItem(localStorageKeyPrefix + formId);
            if (savedData) {
                const formData = JSON.parse(savedData);
                
                // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ë“¤ ë¡œë“œ
                if (formData.checklistItems) {
                    checklistItems = formData.checklistItems;
                    renderChecklist();
                }
                
                for (const id in formData) {
                    if (id === 'checklistItems') continue; // ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” ë³„ë„ ì²˜ë¦¬
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = formData[id];
                        } else {
                            element.value = formData[id];
                        }
                    }
                }
                // console.log('Form data loaded from localStorage');
                // ë°ì´í„° ë¡œë“œ í›„ ë°”ë¡œ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                generateDocument();
            } else {
                generateDocument();
            }
        }
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í¬í•¨)
        function clearForm() {
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.type === 'checkbox') {
                    element.checked = false;
                } else if (element.tagName === 'SELECT') {
                    element.value = ''; // select ë°•ìŠ¤ëŠ” ì²« ë²ˆì§¸ ì˜µì…˜ ë˜ëŠ” ë¹ˆ ê°’ìœ¼ë¡œ
                } else {
                    element.value = ''; // í…ìŠ¤íŠ¸, textarea ë“±ì€ ë¹ˆ ë¬¸ìì—´ë¡œ
                }
            });
            localStorage.removeItem(localStorageKeyPrefix + formId); // localStorageì—ì„œë„ ì‚­ì œ
            generateDocument(); // ì´ˆê¸°í™” í›„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            // console.log('Form data cleared');
        }
        // í˜„ì¬ ì–‘ì‹ ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
        function downloadDataFile() {
            const formData = {};
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                if (element.id) {
                    if (element.type === 'checkbox') {
                        formData[element.id] = element.checked;
                    } else {
                        formData[element.id] = element.value;
                    }
                }
            });
            const dataStr = JSON.stringify(formData, null, 2); // ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ…
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // íŒŒì¼ëª…ì— í˜„ì¬ ì–‘ì‹ëª…ê³¼ ë‚ ì§œ í¬í•¨
            const formTitle = document.getElementById('documentTitle').value.replace(/[^a-zA-Z0-9ê°€-í£_]/g, '_') || 'ìƒˆ_ì–‘ì‹';
            a.download = `${formTitle}_ë°ì´í„°_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // URL ê°ì²´ í•´ì œ
        }
        // JSON íŒŒì¼ì„ ì½ì–´ ì–‘ì‹ì— ë¶ˆëŸ¬ì˜¤ê¸°
        function uploadDataFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    for (const id in loadedData) {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = loadedData[id];
                            } else {
                                element.value = loadedData[id];
                            }
                        }
                    }
                    saveFormDataToLocalStorage(); // ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë„ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
                    generateDocument(); // ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆê±°ë‚˜ ìœ íš¨í•œ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
            // íŒŒì¼ ì„ íƒ í›„ input ê°’ ì´ˆê¸°í™” (ë™ì¼ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
            event.target.value = '';
        }
        
        // ë‚ ì§œ ì°¨ì´ ê³„ì‚° í•¨ìˆ˜
        function calculateDateDifference() {
            const contractEndDate = document.getElementById('contractEndDate').value;
            const moveOutDate = document.getElementById('moveOutDate').value;
            
            if (contractEndDate && moveOutDate) {
                const endDate = new Date(contractEndDate);
                const outDate = new Date(moveOutDate);
                const timeDiff = Math.abs(outDate - endDate);
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                
                document.getElementById('rentDays').value = daysDiff;
                generateDocument(); // ì¼ìˆ˜ê°€ ë³€ê²½ë˜ë©´ ë¬¸ì„œë„ ìë™ ì—…ë°ì´íŠ¸
            }
        }
        
        // ë¬¸ì„œ ìƒì„± í•¨ìˆ˜
        function generateDocument() {
            // ì…ë ¥ê°’ ìˆ˜ì§‘
            const settlementDateInput = document.getElementById('settlementDate');
            const documentTitleInput = document.getElementById('documentTitle');
            const documentVersionInput = document.getElementById('documentVersion');
            const releaseDateInput = document.getElementById('releaseDate');
            const depositReturnInput = document.getElementById('depositReturn');
            const longTermRepairInput = document.getElementById('longTermRepair');
            const monthlyRentInput = document.getElementById('monthlyRent');
            const rentDaysInput = document.getElementById('rentDays');
            const contractEndDateInput = document.getElementById('contractEndDate');
            const moveOutDateInput = document.getElementById('moveOutDate');
            const managementFeeInput = document.getElementById('managementFee');
            const utilityFeeInput = document.getElementById('utilityFee');
            const managementRequestDateInput = document.getElementById('managementRequestDate');
            const depositAccountInput = document.getElementById('depositAccount');
            const managementFeeAccountInput = document.getElementById('managementFeeAccount');
            const memoTextInput = document.getElementById('memoText');
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒíƒœ ìˆ˜ì§‘
            const checks = {};
            checklistItems.forEach((item, index) => {
                const checkbox = document.getElementById(`check${index + 1}`);
                checks[`check${index + 1}`] = checkbox ? checkbox.checked : false;
            });
            
            // ê³¼ë‚©/ë¯¸ë‚© ì²´í¬ ìƒíƒœ í™•ì¸
            const isOverpaid = document.getElementById('overpaid').checked;
            const isUnpaid = document.getElementById('unpaid').checked;
            
            const settlementDate = settlementDateInput.value;
            const documentTitle = documentTitleInput.value || documentTitleInput.placeholder || 'ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œ';
            const documentVersion = documentVersionInput.value || documentVersionInput.placeholder || '';
            const releaseDate = releaseDateInput.value;
            const managementRequestDate = managementRequestDateInput.value;
            // ì‰¼í‘œ ì œê±°í•˜ê³  ìˆ«ìê°’ ì¶”ì¶œ
            const depositReturn = getNumericValue(depositReturnInput.value) || '0';
            const longTermRepair = getNumericValue(longTermRepairInput.value) || '0';
            const monthlyRent = getNumericValue(monthlyRentInput.value) || '0';
            const rentDays = rentDaysInput.value || '0';
            const managementFee = getNumericValue(managementFeeInput.value) || '0';
            const utilityFee = getNumericValue(utilityFeeInput.value) || '0';
            
            // ì›”ì„¸ ì¼í• ê³„ì‚° ê³µì‹: ì›”ì„¸ * ì¼ìˆ˜ * 12 / 365
            const dailyRentCalculation = Math.round((parseFloat(monthlyRent) * parseFloat(rentDays) * 12) / 365);
            
            // ë°˜í™˜ê¸ˆí•©ê³„ ê³„ì‚° (ë³´ì¦ê¸ˆ + ì¥ê¸°ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ, ì›”ì„¸ ì œì™¸)
            let totalRefund = parseFloat(depositReturn) + parseFloat(longTermRepair);
            
            // ì›”ì„¸í¬í•¨ë°˜í™˜ê¸ˆ ê³„ì‚°
            let totalRefundWithRent = totalRefund;
            if (isOverpaid) totalRefundWithRent += dailyRentCalculation;
            else if (isUnpaid) totalRefundWithRent -= dailyRentCalculation;
            const depositAccount = depositAccountInput.value || depositAccountInput.placeholder || 'ê³„ì¢Œ ì •ë³´ ë¯¸ì…ë ¥';
            const managementFeeAccount = managementFeeAccountInput.value || managementFeeAccountInput.placeholder || 'ê³„ì¢Œ ì •ë³´ ë¯¸ì…ë ¥';
            const memoText = memoTextInput.value || '';

            // ì²´í¬ë°•ìŠ¤ HTML ìƒì„± í•¨ìˆ˜
            function getChecklistItem(label, isChecked) {
                const icon = isChecked ? '<i class="fas fa-check-square text-green-600 mr-2"></i>' : '<i class="fas fa-square text-gray-400 mr-2"></i>';
                const textStyle = isChecked ? 'text-decoration-line: line-through; color: #9CA3AF;' : '';
                return `<li class="flex items-start mb-1">${icon}<span style="${textStyle}">${label}</span></li>`;
            }

            // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜ (ì› ë‹¨ìœ„, ì„¸ ìë¦¬ë§ˆë‹¤ ì‰¼í‘œ + í•œê¸€ í‘œê¸°)
            function formatNumber(num) {
                const numValue = parseInt(num) || 0;
                let result = `${numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}ì›`;
                
                // 1000ë§Œì› ì´ìƒì¼ ê²½ìš° í•œê¸€ í‘œê¸° ì¶”ê°€
                if (numValue >= 100000000) { // 1ì–µ ì´ìƒ
                    const eok = Math.floor(numValue / 100000000);
                    const remain = numValue % 100000000;
                    const cheon = Math.floor(remain / 10000000);
                    const manwon = Math.floor((remain % 10000000) / 10000);
                    
                    let hangeul = `${eok}ì–µ`;
                    if (cheon > 0) hangeul += `${cheon}ì²œ`;
                    if (manwon > 0) hangeul += `${manwon}ë§Œ`;
                    hangeul += 'ì›';
                    
                    result += ` (${hangeul})`;
                } else if (numValue >= 10000000) { // 1ì²œë§Œì› ì´ìƒ 1ì–µ ë¯¸ë§Œ
                    const cheon = Math.floor(numValue / 10000000);
                    const manwon = Math.floor((numValue % 10000000) / 10000);
                    
                    let hangeul = '';
                    if (cheon > 0) hangeul += `${cheon}ì²œ`;
                    if (manwon > 0) hangeul += `${manwon}ë§Œ`;
                    hangeul += 'ì›';
                    
                    result += ` (${hangeul})`;
                }
                
                return result;
            }

            // CSS ë³€ìˆ˜ ë™ì  ì„¤ì • (í…Œë§ˆ ìƒ‰ìƒ ë° ë°°ê²½ ì´ë¯¸ì§€)
            const root = document.documentElement;
            let themeColor = '#F97316'; // Orange
            let themeColorLight = '#FED7AA';
            let themeColorStart = '#F97316';
            let themeColorEnd = '#EA580C';
            let headerBgImage = "none";
            let headerBgPosition = 'right 15% top 15%';
            let headerBgSize = '30% auto';
            let headerBgOpacity = 0.15;
            let headerMixBlendMode = 'soft-light';

            root.style.setProperty('--accent-color', themeColor);
            root.style.setProperty('--accent-color-light', themeColorLight);
            root.style.setProperty('--accent-color-start', themeColorStart);
            root.style.setProperty('--accent-color-end', themeColorEnd);
            root.style.setProperty('--header-bg-image', headerBgImage);
            root.style.setProperty('--header-bg-position', headerBgPosition);
            root.style.setProperty('--header-bg-size', headerBgSize);
            root.style.setProperty('--header-bg-opacity', headerBgOpacity);
            root.style.setProperty('--header-mix-blend-mode', headerMixBlendMode);

            // ê°„ë‹¨í•œ í¬ë§·íŒ… í•¨ìˆ˜
            const formatKRW = (num) => {
                const numValue = parseInt(num) || 0;
                return `${numValue.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}ì›`;
            };

            // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ (2025ë…„ 8ì›” 30ì¼ í˜•íƒœ)
            const formatDate = (dateString) => {
                if (!dateString) return 'ë¯¸ì •';
                const date = new Date(dateString);
                return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            };

            // ë‚ ì§œì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (2025ë…„ 8ì›” 30ì¼ 10ì‹œ 59ë¶„ í˜•íƒœ)
            const formatDateTime = (dateTimeString) => {
                if (!dateTimeString) return 'ë¯¸ì •';
                const date = new Date(dateTimeString);
                const hours = date.getHours();
                const minutes = date.getMinutes();
                return `${date.getFullYear()}ë…„ ${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ ${hours}ì‹œ ${minutes}ë¶„`;
            };

            let generatedHtml = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px;">
                    <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <div style="margin-bottom: 12px;">
                            <div>
                                <h3 style="font-weight: 600; color: #374151; font-size: 16px; margin: 0 0 8px 0; display: flex; align-items: center;">
                                    ğŸ“„ ${documentTitle || 'ë¯¸ì§€ì •'} ì”ê¸ˆ ì •ì‚° í™•ì¸ì„œ
                                </h3>
                                <div style="font-size: 12px; margin-top: 4px;">
                                    <div style="margin-bottom: 2px; color: #dc2626;"><strong>í‡´ì‹¤ì ê²€:</strong> ${documentVersion ? formatDateTime(documentVersion) : 'ë¯¸ì •'}</div>
                                    <div style="margin-bottom: 2px; color: #dc2626;"><strong>ì…ì£¼ì ê²€:</strong> ${releaseDate ? formatDateTime(releaseDate) : 'ë¯¸ì •'}</div>
                                    ${managementRequestDate ? `<div style="margin-bottom: 2px; color: #2563eb;"><strong>ê´€ë¦¬ë¹„ì •ì‚°ìš”ì²­ì¼:</strong> ${formatDate(managementRequestDate)}</div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${settlementDate ? `<div style="margin-bottom: 4px;"><strong>ì”ê¸ˆì¼:</strong> ${formatDate(settlementDate)}</div>` : ''}
                        </div>
                    </div>

                    <!-- ì •ì‚° ë‚´ì—­ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            ğŸ’° ì •ì‚° ë‚´ì—­
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${depositReturn && parseInt(depositReturn) > 0 ? `<span>ë³´ì¦ê¸ˆ: ${formatKRW(depositReturn)}</span>` : ''}${longTermRepair && parseInt(longTermRepair) > 0 ? `${depositReturn && parseInt(depositReturn) > 0 ? '<br>' : ''}<span>ì¥ê¸°ìˆ˜ì„ : ${formatKRW(longTermRepair)}</span>` : ''}${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `${(depositReturn && parseInt(depositReturn) > 0) || (longTermRepair && parseInt(longTermRepair) > 0) ? '<br>' : ''}<span>ì›”ì„¸ ${isOverpaid ? '(ê³¼ë‚©)' : '(ë¯¸ë‚©)'}: ${isUnpaid ? '- ' : ''}${formatKRW(dailyRentCalculation)}</span>` : ''}
                            <div style="font-weight: 600; border-top: 1px solid #d1d5db; padding-top: 4px; margin-top: 8px;">
                                ë°˜í™˜ê¸ˆí•©ê³„: ${formatKRW(totalRefund)}
                            </div>
                            ${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `
                                <div style="font-weight: 600; margin-top: 4px; color: #059669;">
                                    ì›”ì„¸í¬í•¨ë°˜í™˜ê¸ˆ: ${formatKRW(totalRefundWithRent)}
                                </div>
                            ` : ''}
                            ${(isOverpaid || isUnpaid) && dailyRentCalculation > 0 ? `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 12px; ${isUnpaid ? 'color: #dc2626;' : 'color: #2563eb;'} font-weight: 500;">
                                        ${isUnpaid ? 
                                            `ë¯¸ë‚©ì›”ì„¸ ${formatKRW(dailyRentCalculation)}ì„ ì„ëŒ€ì¸ì—ê²Œ ë‚©ë¶€í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.` :
                                            `ë” ë‚©ë¶€ëœ ì›”ì„¸ ${formatKRW(dailyRentCalculation)}ì„ ì„¸ì…ìì—ê²Œ ë°˜í™˜í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.`
                                        }
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${(managementFee && parseInt(managementFee) > 0) || (utilityFee && parseInt(utilityFee) > 0) ? `
                    <!-- ê´€ë¦¬ë¹„/ê³µê³¼ê¸ˆ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            ğŸ§¾ ê´€ë¦¬ë¹„/ê³µê³¼ê¸ˆ
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${managementFee && parseInt(managementFee) > 0 ? `<span>ê´€ë¦¬ë¹„: ${formatKRW(managementFee)}</span>` : ''}${utilityFee && parseInt(utilityFee) > 0 ? `${managementFee && parseInt(managementFee) > 0 ? '<br>' : ''}<span>ê³µê³¼ê¸ˆ: ${formatKRW(utilityFee)}</span>` : ''}
                            ${managementFee && parseInt(managementFee) > 0 ? `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 11px; color: #6b7280; line-height: 1.4;">
                                    ë³¸ ì˜¤í”¼ìŠ¤í…”ì€ ì „ì¶œì… ì„¸ì…ìê°„ì— ê´€ë¦¬ë¹„ë¥¼ ìŠ¹ê³„í•˜ëŠ” ê²ƒì„ ì›ì¹™ìœ¼ë¡œ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì „ì…ì„¸ì…ìë¶„ì˜ ê³„ì¢Œë²ˆí˜¸ê°€ í™•ì¸ë˜ëŠ”ë°ë¡œ ë³´ë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. í•´ë‹¹ ê³„ì¢Œë¡œ ê´€ë¦¬ë¹„ë¥¼ ì…ê¸ˆí•´ ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.<br>
                                    <strong style="color: #374151;">ê´€ë¦¬ë¹„ìŠ¹ê³„ ê³„ì¢Œë²ˆí˜¸:</strong>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${(depositAccount || managementFeeAccount) ? `
                    <!-- ê³„ì¢Œ ì •ë³´ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            ğŸ¦ ê³„ì¢Œ ì •ë³´
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${depositAccount ? `
                                <div style="margin-bottom: 8px;">
                                    <strong style="display: block; margin-bottom: 4px;">ë³´ì¦ê¸ˆ/ì¥ê¸°ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ ë°˜í™˜ ê³„ì¢Œ:</strong>
                                    <div style="white-space: pre-wrap; padding-left: 8px; color: #6b7280;">${depositAccount}</div>
                                </div>
                            ` : ''}
                            ${managementFeeAccount ? `
                                <div style="margin-bottom: 8px;">
                                    <strong style="display: block; margin-bottom: 4px;">ê´€ë¦¬ë¹„ ìŠ¹ê³„ ê³„ì¢Œ:</strong>
                                    <div style="white-space: pre-wrap; padding-left: 8px; color: #6b7280;">${managementFeeAccount}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${checklistItems.length > 0 ? `
                    <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 12px 0;">
                            âœ… ì”ê¸ˆì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸
                        </h4>
                        <div style="font-size: 12px; color: #4b5563;">
                            ${checklistItems.map((item, index) => {
                                const isChecked = checks[`check${index + 1}`];
                                const icon = isChecked ? 'âœ…' : 'â¬œ';
                                const textStyle = isChecked ? 'text-decoration: line-through; color: #9ca3af;' : '';
                                return `<div style="display: flex; align-items: flex-start; margin-bottom: 4px;"><span style="margin-right: 8px;">${icon}</span><span style="${textStyle}">${item}</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${memoText ? `
                    <!-- ë©”ëª¨ ì¹´ë“œ -->
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background-color: #f9fafb; margin-bottom: 16px;">
                        <h4 style="font-weight: 600; color: #374151; font-size: 14px; margin: 0 0 8px 0; display: flex; align-items: center;">
                            <span style="margin-right: 8px;">ğŸ“</span>
                            <span>ë©”ëª¨</span>
                        </h4>
                        <div style="font-size: 12px; color: #4b5563; white-space: pre-wrap; line-height: 1.6; text-align: left; vertical-align: top; word-wrap: break-word; margin-left: 0; padding-left: 0;">${memoText}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('documentPreview').innerHTML = generatedHtml;
            // ëª¨ë°”ì¼ì—ì„œ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ë¯¸ë¦¬ë³´ê¸° íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
            if (window.innerWidth < 1280) {
                const currentActiveTab = document.querySelector('.mobile-tab-active');
                if (currentActiveTab && currentActiveTab.id === 'tab-input') {
                    // ì…ë ¥ íƒ­ì—ì„œ ì €ì¥í–ˆë‹¤ë©´ ë¯¸ë¦¬ë³´ê¸° íƒ­ìœ¼ë¡œ ì „í™˜
                    showMobileTab('preview');
                }
            }
        }
        // placeholder í…ìŠ¤íŠ¸ë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì±„ìš°ëŠ” í•¨ìˆ˜
        function setupInputPlaceholders() {
            const inputs = document.querySelectorAll('#documentForm input[placeholder], #documentForm textarea[placeholder]');
            inputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab' && input.value.trim() === '') {
                        e.preventDefault(); // ê¸°ë³¸ Tab ë™ì‘ ë°©ì§€
                        input.value = input.placeholder;
                        saveFormDataToLocalStorage(); // Tab í‚¤ë¡œ ì…ë ¥ ì‹œ ìë™ ì €ì¥
                        generateDocument(); // Tab í‚¤ë¡œ ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    }
                });
            });
        }
        // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        async function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebaseStatus');
            const mobileStatusDiv = document.getElementById('mobileFirebaseStatus');
            
            if (useFirebase) {
                try {
                    console.log('ğŸ” Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                    const testData = {
                        test: true,
                        timestamp: new Date().toISOString(),
                        roomName: 'Firebase ì—°ê²° í…ŒìŠ¤íŠ¸',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    const docRef = await settlementsCollection.add(testData);
                    await settlementsCollection.doc(docRef.id).delete(); // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¦‰ì‹œ ì‚­ì œ
                    console.log('âœ… Firebase ì—°ê²° ë° ì½ê¸°/ì“°ê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
                    console.log('ğŸŒ í´ë¼ìš°ë“œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.');
                    
                    // ë°ìŠ¤í¬í†± UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (statusDiv) {
                        statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-green-100 text-green-800';
                        statusDiv.innerHTML = '<i class="fas fa-cloud mr-2"></i><span>í´ë¼ìš°ë“œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ë¨ - ì–´ë””ì„œë‚˜ ì ‘ê·¼ ê°€ëŠ¥</span>';
                    }
                    
                    // ëª¨ë°”ì¼ UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (mobileStatusDiv) {
                        mobileStatusDiv.innerHTML = '<i class="fas fa-cloud text-green-600"></i>';
                        mobileStatusDiv.title = 'í´ë¼ìš°ë“œ DB ì—°ê²°ë¨';
                    }
                    
                    return true;
                } catch (error) {
                    console.log('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                    console.log('ğŸ’¾ localStorageë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.');
                    
                    // ë°ìŠ¤í¬í†± UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (statusDiv) {
                        statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-yellow-100 text-yellow-800';
                        statusDiv.innerHTML = '<i class="fas fa-database mr-2"></i><span>ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘ - ì´ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì ‘ê·¼</span>';
                    }
                    
                    // ëª¨ë°”ì¼ UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (mobileStatusDiv) {
                        mobileStatusDiv.innerHTML = '<i class="fas fa-database text-yellow-600"></i>';
                        mobileStatusDiv.title = 'ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©';
                    }
                    
                    return false;
                }
            } else {
                console.log('ğŸ’¾ Firebaseê°€ ë¹„í™œì„±í™”ë˜ì–´ localStorageë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.');
                
                // ë°ìŠ¤í¬í†± UI ìƒíƒœ ì—…ë°ì´íŠ¸
                if (statusDiv) {
                    statusDiv.className = 'mt-3 text-sm font-medium px-3 py-1 rounded-full inline-flex items-center bg-gray-100 text-gray-800';
                    statusDiv.innerHTML = '<i class="fas fa-database mr-2"></i><span>ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©</span>';
                }
                
                // ëª¨ë°”ì¼ UI ìƒíƒœ ì—…ë°ì´íŠ¸
                if (mobileStatusDiv) {
                    mobileStatusDiv.innerHTML = '<i class="fas fa-database text-gray-600"></i>';
                    mobileStatusDiv.title = 'ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©';
                }
                
                return false;
            }
        }

        // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ê´€ë¦¬ ë³€ìˆ˜ë“¤
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const minSwipeDistance = 50; // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬
        const maxVerticalDistance = 100; // ì„¸ë¡œ ë°©í–¥ ìµœëŒ€ í—ˆìš© ê±°ë¦¬

        // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ê°ì§€ í•¨ìˆ˜ë“¤
        function handleTouchStart(e) {
            // ëª¨ë°”ì¼ í™˜ê²½ì´ ì•„ë‹ˆê³  ê°•ì œ ëª¨ë°”ì¼ ë·°ë„ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            const firstTouch = e.touches[0];
            touchStartX = firstTouch.clientX;
            touchStartY = firstTouch.clientY;
        }

        function handleTouchMove(e) {
            // ëª¨ë°”ì¼ í™˜ê²½ì´ ì•„ë‹ˆê³  ê°•ì œ ëª¨ë°”ì¼ ë·°ë„ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            if (!touchStartX || !touchStartY) return;

            const currentTouch = e.touches[0];
            touchEndX = currentTouch.clientX;
            touchEndY = currentTouch.clientY;

            // ì„¸ë¡œ ìŠ¤ì™€ì´í”„ê°€ ë„ˆë¬´ í¬ë©´ ê°€ë¡œ ìŠ¤ì™€ì´í”„ë¡œ ì¸ì‹í•˜ì§€ ì•ŠìŒ
            const verticalDistance = Math.abs(touchEndY - touchStartY);
            const horizontalDistance = Math.abs(touchEndX - touchStartX);
            
            // ê°€ë¡œ ìŠ¤ì™€ì´í”„ê°€ ì„¸ë¡œ ìŠ¤ì™€ì´í”„ë³´ë‹¤ í¬ê³ , ì„¸ë¡œ ê±°ë¦¬ê°€ í—ˆìš© ë²”ìœ„ ë‚´ì¼ ë•Œë§Œ ìŠ¤í¬ë¡¤ ë°©ì§€
            if (horizontalDistance > verticalDistance && verticalDistance < maxVerticalDistance) {
                e.preventDefault(); // ìŠ¤ì™€ì´í”„ ì¤‘ í˜ì´ì§€ ìŠ¤í¬ë¡¤ ë°©ì§€
            }
        }

        function handleTouchEnd(e) {
            // ëª¨ë°”ì¼ í™˜ê²½ì´ ì•„ë‹ˆê³  ê°•ì œ ëª¨ë°”ì¼ ë·°ë„ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            if (!touchStartX || !touchStartY) return;

            const horizontalDistance = touchEndX - touchStartX;
            const verticalDistance = Math.abs(touchEndY - touchStartY);

            // ì„¸ë¡œ ë°©í–¥ ì´ë™ì´ ë„ˆë¬´ í¬ë©´ ìŠ¤ì™€ì´í”„ë¡œ ì¸ì‹í•˜ì§€ ì•ŠìŒ
            if (verticalDistance > maxVerticalDistance) {
                resetTouchVariables();
                return;
            }

            // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬ ì²´í¬
            if (Math.abs(horizontalDistance) < minSwipeDistance) {
                resetTouchVariables();
                return;
            }

            // í˜„ì¬ í™œì„± íƒ­ í™•ì¸
            const currentActiveTab = document.querySelector('.mobile-tab-active');
            if (!currentActiveTab) {
                resetTouchVariables();
                return;
            }

            const currentTabId = currentActiveTab.id;
            let nextTab = null;

            if (horizontalDistance > 0) {
                // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ (ì´ì „ íƒ­ìœ¼ë¡œ)
                console.log('ğŸ‘† ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ ê°ì§€ - ì´ì „ íƒ­ìœ¼ë¡œ');
                if (currentTabId === 'tab-input') {
                    nextTab = 'list';
                } else if (currentTabId === 'tab-preview') {
                    nextTab = 'input';
                }
            } else {
                // ì™¼ìª½ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ íƒ­ìœ¼ë¡œ)
                console.log('ğŸ‘† ì™¼ìª½ ìŠ¤ì™€ì´í”„ ê°ì§€ - ë‹¤ìŒ íƒ­ìœ¼ë¡œ');
                if (currentTabId === 'tab-list') {
                    nextTab = 'input';
                } else if (currentTabId === 'tab-input') {
                    nextTab = 'preview';
                }
            }

            if (nextTab) {
                console.log('ğŸ‘† íƒ­ ì „í™˜:', currentTabId, 'â†’', nextTab);
                showMobileTab(nextTab);
                
                // í–…í‹± í”¼ë“œë°± (ì§€ì›ë˜ëŠ” ê¸°ê¸°ì—ì„œ)
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            resetTouchVariables();
        }

        function resetTouchVariables() {
            touchStartX = 0;
            touchStartY = 0;
            touchEndX = 0;
            touchEndY = 0;
        }

        // ëª¨ë°”ì¼ íƒ­ ì „í™˜ ê¸°ëŠ¥
        function showMobileTab(tabName) {
            // ëª¨ë°”ì¼ í™˜ê²½ì´ ì•„ë‹ˆê³  ê°•ì œ ëª¨ë°”ì¼ ë·°ë„ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sections = document.querySelectorAll('.mobile-section');
            sections.forEach(section => {
                section.classList.remove('mobile-active');
            });
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì ìš©
            const tabs = document.querySelectorAll('#mobileTabNav button');
            tabs.forEach(tab => {
                tab.className = 'flex-1 py-3 px-4 text-center text-gray-600 hover:bg-gray-50 mobile-tab-inactive';
            });
            
            // ì„ íƒëœ íƒ­ê³¼ ì„¹ì…˜ í™œì„±í™”
            const targetSection = document.getElementById(tabName + 'Section');
            const targetTab = document.getElementById('tab-' + tabName);
            
            if (targetSection) {
                targetSection.classList.add('mobile-active');
            }
            
            if (targetTab) {
                targetTab.className = 'flex-1 py-3 px-4 text-center bg-blue-500 text-white mobile-tab-active';
            }
            
            // ì„¹ì…˜ì´ ë³€ê²½ë˜ë©´ ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
            window.scrollTo(0, 0);
        }

        // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€í•˜ì—¬ ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼ ëª¨ë“œ ì „í™˜
        function handleResize() {
            // ê°•ì œ ëª¨ë°”ì¼ ë·° ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰
            if (!document.body.classList.contains('force-mobile-view')) {
                if (window.innerWidth >= 1280) {
                    // ë°ìŠ¤í¬í†± ëª¨ë“œ: ëª¨ë“  ì„¹ì…˜ í‘œì‹œ
                    const sections = document.querySelectorAll('.mobile-section');
                    sections.forEach(section => {
                        section.classList.remove('mobile-active');
                    });
                } else {
                    // ëª¨ë°”ì¼ ëª¨ë“œ: í™œì„±í™”ëœ íƒ­ë§Œ í‘œì‹œ (ê¸°ë³¸ì ìœ¼ë¡œ ëª©ë¡ íƒ­)
                    const activeSection = document.querySelector('.mobile-section.mobile-active');
                    if (!activeSection) {
                        showMobileTab('list'); // ê¸°ë³¸ì ìœ¼ë¡œ ëª©ë¡ íƒ­ í™œì„±í™”
                    }
                }
            }
        }

        // ìŠ¤ì™€ì´í”„ íŒíŠ¸ í‘œì‹œ í•¨ìˆ˜
        function showSwipeHint() {
            // ëª¨ë°”ì¼ í™˜ê²½ì´ ì•„ë‹ˆê³  ê°•ì œ ëª¨ë°”ì¼ ë·°ë„ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            if (window.innerWidth >= 1280 && !document.body.classList.contains('force-mobile-view')) return;
            
            // ì´ë¯¸ íŒíŠ¸ë¥¼ ë³¸ ì ì´ ìˆìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            if (localStorage.getItem('swipe_hint_shown')) return;
            
            const hint = document.createElement('div');
            hint.className = 'swipe-hint';
            hint.innerHTML = 'â† ì¢Œìš° ìŠ¤ì™€ì´í”„ë¡œ íƒ­ ì´ë™ â†’';
            
            document.body.appendChild(hint);
            
            // 3ì´ˆ í›„ íŒíŠ¸ ì œê±°
            setTimeout(() => {
                if (hint.parentNode) {
                    hint.remove();
                }
            }, 3000);
            
            // íŒíŠ¸ í‘œì‹œ ì™„ë£Œ ê¸°ë¡
            localStorage.setItem('swipe_hint_shown', 'true');
        }

        // ëª¨ë°”ì¼ ë·° í…ŒìŠ¤íŠ¸ í† ê¸€ (ê°œë°œììš©)
        function toggleMobileView() {
            const body = document.body;
            const testBtn = document.getElementById('mobileTestBtn');
            
            if (body.classList.contains('force-mobile-view')) {
                // ëª¨ë°”ì¼ ë·° í•´ì œ
                body.classList.remove('force-mobile-view');
                testBtn.textContent = 'ğŸ“± ëª¨ë°”ì¼ ë·° í…ŒìŠ¤íŠ¸';
                testBtn.className = 'text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors';
                
                // ëª¨ë“  ì„¹ì…˜ í‘œì‹œ
                const sections = document.querySelectorAll('.mobile-section');
                sections.forEach(section => {
                    section.classList.remove('mobile-active');
                });
            } else {
                // ëª¨ë°”ì¼ ë·° ê°•ì œ í™œì„±í™”
                body.classList.add('force-mobile-view');
                testBtn.textContent = 'ğŸ’» ë°ìŠ¤í¬í†± ë·° ë³µì›';
                testBtn.className = 'text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors';
                
                // ëª©ë¡ íƒ­ì„ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”
                showMobileTab('list');
            }
        }

        // ì´ˆê¸°í™” ë° ìë™ ì €ì¥/ë¡œë“œ ê¸°ëŠ¥ ì„¤ì •
        document.addEventListener('DOMContentLoaded', async function() {
            // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            setTimeout(async () => {
                await testFirebaseConnection();
            }, 1000); // 1ì´ˆ í›„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            
            // ëª¨ë°”ì¼ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            handleResize(); // ì´ˆê¸° í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ëª¨ë“œ ì„¤ì •
            window.addEventListener('resize', handleResize); // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
            
            // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.addEventListener('touchstart', handleTouchStart, { passive: false });
                mainContent.addEventListener('touchmove', handleTouchMove, { passive: false });
                mainContent.addEventListener('touchend', handleTouchEnd, { passive: true });
                console.log('ğŸ‘† ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            }
            
            // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ìŠ¤ì™€ì´í”„ íŒíŠ¸ í‘œì‹œ (3ì´ˆ í›„)
            setTimeout(() => {
                showSwipeHint();
            }, 3000);
            
            setupInputPlaceholders(); // Tab í‚¤ ê¸°ëŠ¥ ì„¤ì •
            renderChecklist(); // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì´ˆê¸° ë Œë”ë§
            setupChecklistEnterKey(); // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—”í„° í‚¤ ì„¤ì •
            setupNumberFormatting(); // ìˆ«ì í¬ë§·íŒ… ì„¤ì •
            loadFormDataFromLocalStorage(); // í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            updateSettlementListUI(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ì‚°ì„œ ëª©ë¡ UI ì´ˆê¸°í™”
            // ëª¨ë“  ì…ë ¥ í•„ë“œì— input ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€í•˜ì—¬ ë°ì´í„° ë³€ê²½ ì‹œ ìë™ ì €ì¥
            const formElements = document.querySelectorAll(`#${formId} input, #${formId} textarea, #${formId} select`);
            formElements.forEach(element => {
                element.addEventListener('input', () => {
                    saveFormDataToLocalStorage();
                    generateDocument(); // ì…ë ¥ ì‹œ ë¯¸ë¦¬ë³´ê¸° ìë™ ì—…ë°ì´íŠ¸
                });
                element.addEventListener('change', () => { // select, date, checkbox ë“± ë³€ê²½ ì‹œ
                    saveFormDataToLocalStorage();
                    generateDocument(); // ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ìë™ ì—…ë°ì´íŠ¸
                });
            });
            
            // ë§Œê¸°ì¼, í‡´ì‹¤ì¼ ë³€ê²½ ì‹œ ì¼ìˆ˜ ìë™ ê³„ì‚°
            document.getElementById('contractEndDate').addEventListener('change', calculateDateDifference);
            document.getElementById('moveOutDate').addEventListener('change', calculateDateDifference);
            
            document.getElementById('clearFormButton').addEventListener('click', function() {
                console.log('ğŸ—‘ï¸ ì–‘ì‹ ì´ˆê¸°í™” - ì´ì „ currentSettlementId:', currentSettlementId);
                clearForm();
                currentSettlementId = null; // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì •ì‚°ì„œ ID ì´ˆê¸°í™”
                console.log('ğŸ—‘ï¸ ì–‘ì‹ ì´ˆê¸°í™” ì™„ë£Œ - ìƒˆë¡œìš´ currentSettlementId:', currentSettlementId);
                updateSettlementListUI(); // ëª©ë¡ UI ì—…ë°ì´íŠ¸
            }); // ì–‘ì‹ ì´ˆê¸°í™” ë²„íŠ¼
            
            // Ctrl+S ë‹¨ì¶•í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í¼ ì œì¶œê³¼ ë™ì¼í•˜ê²Œ ì‘ë™)
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault(); // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì €ì¥ ë™ì‘ ë°©ì§€
                    document.getElementById('documentForm').dispatchEvent(new Event('submit'));
                }
            });
            // í¼ ì œì¶œ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ ë° ì •ì‚°ì„œ ì €ì¥
            document.getElementById('documentForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                try {
                    // ì •ì‚°ì„œ ì €ì¥
                    const settlementId = await saveCurrentSettlement();
                    
                    // ë¬¸ì„œ ìƒì„±
                    generateDocument();
                    
                    // ëª¨ë°”ì¼ì—ì„œ ì €ì¥ í›„ ë¯¸ë¦¬ë³´ê¸° íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
                    if (window.innerWidth < 1280) {
                        showMobileTab('preview');
                    }
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    const roomName = document.getElementById('documentTitle').value || 'ë¯¸ì§€ì •';
                    alert(`${roomName} ì •ì‚°ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    console.error('í¼ ì œì¶œ ì¤‘ ì˜¤ë¥˜:', error);
                    alert('ì •ì‚°ì„œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

    </script>

</body>
</html>